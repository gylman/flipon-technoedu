function tsip_dialog_layer(a){if(!a){tsk_utils_log_error("Invalid argument");return null}this.o_stack=a;this.ao_dialogs=new Array();this.shutdown={};this.shutdown.b_inprogress=false;this.shutdown.b_phase2=false;this.b_locked=false}function tsip_dialog_layer_find_result(b,a){this.o_dialog=b;this.b_cid_matched=a}tsip_dialog_layer.prototype.find_by_ss=function(a){if(!a){tsk_utils_log_error("Invalid argument");return null}return this.find_by_ssid(a.i_id)};tsip_dialog_layer.prototype.find_by_ssid=function(b){var c=null;while(this.b_locked){}this.b_locked=true;for(var a=0;a<this.ao_dialogs.length;++a){if(this.ao_dialogs[a].o_session&&this.ao_dialogs[a].o_session.i_id==b){c=this.ao_dialogs[a];break}}this.b_locked=false;return c};tsip_dialog_layer.prototype.find=function(c,b,j,k){var d=null;var e;var a=false;while(this.b_locked){}this.b_locked=true;for(var g=0;g<this.ao_dialogs.length;++g){e=this.ao_dialogs[g];if(tsk_string_equals(e.s_callid,c)){var h=(k==tsip_request_type_e.CANCEL);var f=(k==tsip_request_type_e.REGISTER);var l=(k==tsip_request_type_e.NOTIFY);a=true;if((h||tsk_string_equals(e.s_tag_local,j))&&(!e.s_tag_remote||tsk_string_equals(e.s_tag_remote,b))){d=e;break}if(f){d=e;break}if(l){d=e;break}}}this.b_locked=false;return new tsip_dialog_layer_find_result(d,a)};tsip_dialog_layer.prototype.dialog_new=function(a,b){var c=null;while(this.b_locked){}this.b_locked=true;switch(a){case tsip_dialog_type_e.REGISTER:if((c=new tsip_dialog_register(b,null))){this.ao_dialogs.push(c)}break;case tsip_dialog_type_e.INVITE:if((c=new tsip_dialog_invite(b,null))){this.ao_dialogs.push(c)}break;case tsip_dialog_type_e.MESSAGE:case tsip_dialog_type_e.INFO:case tsip_dialog_type_e.OPTIONS:case tsip_dialog_type_e.PUBLISH:case tsip_dialog_type_e.SUBSCRIBE:default:if((c=new tsip_dialog_generic(a,b,null))){this.ao_dialogs.push(c)}break}this.b_locked=false;return c};tsip_dialog_layer.prototype.dialog_remove=function(b){if(b){while(this.b_locked){}this.b_locked=true;for(var a=0;a<this.ao_dialogs.length;++a){if(this.ao_dialogs[a]==b){this.ao_dialogs.splice(a,1);break}}this.b_locked=false}};tsip_dialog_layer.prototype.handle_incoming_message=function(a){var h=-1;var j=null;var f=this.o_stack.o_layer_transac;var d=this.find(a.o_hdr_Call_ID.s_value,a.is_response()?a.o_hdr_To.s_tag:a.o_hdr_From.s_tag,a.is_response()?a.o_hdr_From.s_tag:a.o_hdr_To.s_tag,a.is_request()?a.line.request.e_type:tsip_request_type_e.NONE);var c=d.b_cid_matched;var e=d.o_dialog;if(e){if(a.is_cancel()||a.is_ack()){return e.callback(tsip_dialog_event_type_e.I_MSG,a)}else{j=f.transac_new(false,a,e)}}else{if(a.is_request()){var i=null;var g=null;switch(a.line.request.e_type){case tsip_request_type_e.MESSAGE:if((i=new tsip_session_message(this.o_stack,tsip_session.prototype.SetInitialMessage(a)))){g=new tsip_dialog_generic(tsip_dialog_type_e.MESSAGE,i,a.o_hdr_Call_ID?a.o_hdr_Call_ID.s_value:null)}break;case tsip_request_type_e.INFO:tsk_utils_log_warn("Not implemented");break;case tsip_request_type_e.OPTIONS:tsk_utils_log_error("Not implemented");break;case tsip_request_type_e.REGISTER:tsk_utils_log_error("Not implemented");break;case tsip_request_type_e.INVITE:if((i=new tsip_session_invite(this.o_stack,tsip_session.prototype.SetInitialMessage(a)))){g=new tsip_dialog_invite(i,a.o_hdr_Call_ID?a.o_hdr_Call_ID.s_value:null)}break;default:break}if(g){j=f.transac_new(false,a,g);this.ao_dialogs.push(g)}}}if(j){h=j.start(a)}else{if(a.is_request()){var k=this.o_stack.o_layer_transport;var b=null;if(k){if(c){b=new tsip_response(482,"Loop Detected (Check your iFCs)",a);if(b&&!b.o_hdr_To.s_tag){b.o_hdr_To.s_tag="tag_doubango"}}else{switch(a.line.request.e_type){case tsip_request_type_e.OPTIONS:case tsip_request_type_e.INFO:b=new tsip_response(405,"Method Not Allowed",a);break;default:b=new tsip_response(481,"Dialog/Transaction Does Not Exist",a);break}}if(b){h=k.send(b.o_hdr_firstVia?b.o_hdr_firstVia.s_branch:"no-branch",b)}}}}return h};