tsip_dialog_generic.prototype=Object.create(tsip_dialog.prototype);tsip_dialog_generic.prototype.__b_debug_state_machine=true;var tsip_dialog_generic_actions_e={ACCEPT:tsip_action_type_e.ACCEPT,REJECT:tsip_action_type_e.REJECT,HANGUP:tsip_action_type_e.HANGUP,CANCEL:tsip_action_type_e.CANCEL,SHUTDOWN:tsip_action_type_e.SHUTDOWN,O_SUBSCRIBE:tsip_action_type_e.SUBSCRIBE,O_OPTIONS:tsip_action_type_e.OPTIONS,O_MESSAGE:tsip_action_type_e.MESSAGE,O_INFO:tsip_action_type_e.INFO,O_PUBLISH:tsip_action_type_e.PUBLISH,O_UNPUBLISH:tsip_action_type_e.UNPUBLISH,I_SUBSCRIBE:10000,I_MESSAGE:10001,I_OPTIONS:10002,I_INFO:10003,I_PUBLISH:10004,I_NOTIFY:10005,I_1XX:50000,I_2XX:50001,I_401_407_421_494:50002,I_423:50003,I_300_to_699:50004,SHUTDOWN_TIMEDOUT:60000,TRANSPORT_ERROR:60002,ERROR:60003};var tsip_dialog_generic_states_e={STARTED:0,INPROGRESS:1,INCOMING:2,CONNECTED:3,TERMINATED:4};function tsip_dialog_generic(b,c,a){tsip_dialog.call(this);this.b_disconnecting=false;this.o_last_iMessage=null;this.o_timerRefresh=null;this.o_timerShutdown=null;this.i_timerShutdown=(tsip_dialog.prototype.__i_timer_shutdown<<1)/3;this.init(b,a,c,tsip_dialog_generic_states_e.STARTED,tsip_dialog_generic_states_e.TERMINATED);this.set_callback(__tsip_dialog_generic_event_callback);this.o_fsm.set_debug_enabled(tsip_dialog_generic.prototype.__b_debug_state_machine);this.o_fsm.set_onterm_callback(__tsip_dialog_generic_onterm,this);this.init_message();this.init_publish();this.init_subscribe();this.o_fsm.set(tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.I_1XX,tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_InProgress_2_InProgress_X_1xx,"tsip_dialog_generic_InProgress_2_InProgress_X_1xx"),tsk_fsm_entry.prototype.Create(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.I_2XX,__tsip_dialog_generic_cond_is_dialogless,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_InProgress_2_Terminated_X_2xx,"tsip_dialog_generic_InProgress_2_Terminated_X_2xx"),tsk_fsm_entry.prototype.Create(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.I_2XX,__tsip_dialog_generic_cond_is_disconnecting,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_InProgress_2_Terminated_X_2xx,"tsip_dialog_generic_InProgress_2_Terminated_X_2xx"),tsk_fsm_entry.prototype.Create(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.I_2XX,__tsip_dialog_generic_cond_is_dialogfull,tsip_dialog_generic_states_e.CONNECTED,tsip_dialog_generic_InProgress_2_Connected_X_2xx,"tsip_dialog_generic_InProgress_2_Connected_X_2xx"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.I_401_407_421_494,tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_InProgress_2_InProgress_X_401_407_421_494,"tsip_dialog_generic_InProgress_2_InProgress_X_401_407_421_494"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.I_300_to_699,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_InProgress_2_Terminated_X_300_to_699,"tsip_dialog_generic_InProgress_2_Terminated_X_300_to_699"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.CANCEL,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_InProgress_2_Terminated_X_cancel,"tsip_dialog_generic_InProgress_2_Terminated_X_cancel"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_generic_states_e.INPROGRESS,tsip_dialog_generic_actions_e.SHUTDOWN,tsip_dialog_generic_states_e.TERMINATED,null,"tsip_dialog_generic_InProgress_2_Terminated_X_shutdown"),tsk_fsm_entry.prototype.Create(tsip_dialog_generic_states_e.INCOMING,tsip_dialog_generic_actions_e.ACCEPT,__tsip_dialog_generic_cond_is_dialogless,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_Incoming_2_Terminated_X_accept,"tsip_dialog_generic_Incoming_2_Terminated_X_accept"),tsk_fsm_entry.prototype.Create(tsip_dialog_generic_states_e.INCOMING,tsip_dialog_generic_actions_e.ACCEPT,__tsip_dialog_generic_cond_is_dialogfull,tsip_dialog_generic_states_e.CONNECTED,tsip_dialog_generic_Incoming_2_Connected_X_accept,"tsip_dialog_generic_Incoming_2_Connected_X_accept"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_generic_states_e.INCOMING,tsip_dialog_generic_actions_e.REJECT,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_Incoming_2_Terminated_X_reject,"tsip_dialog_generic_Incoming_2_Terminated_X_reject"),tsk_fsm_entry.prototype.CreateAlwaysNothing(tsip_dialog_generic_states_e.INCOMING,"tsip_dialog_generic_Incoming_2_Incoming_X_any"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.HANGUP,__tsip_dialog_generic_cond_not_silent_hangup,tsip_dialog_generic_states_e.INPROGRESS,__tsip_dialog_generic_Any_2_InProgress_X_hangup,"tsip_dialog_generic_Any_2_InProgress_X_hangup"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.HANGUP,__tsip_dialog_generic_cond_silent_hangup,tsip_dialog_generic_states_e.TERMINATED,null,"tsip_dialog_generic_Any_2_InProgress_X_silenthangup"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.SHUTDOWN,__tsip_dialog_generic_cond_not_silent_shutdown,tsip_dialog_generic_states_e.INPROGRESS,__tsip_dialog_generic_Any_2_InProgress_X_shutdown,"tsip_dialog_generic_Any_2_InProgress_X_shutdown"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.SHUTDOWN,__tsip_dialog_generic_cond_silent_shutdown,tsip_dialog_generic_states_e.TERMINATED,null,"tsip_dialog_generic_Any_2_InProgress_X_silentshutdown"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.SHUTDOWN_TIMEDOUT,tsip_dialog_generic_states_e.TERMINATED,null,"tsip_dialog_generic_shutdown_timedout"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.TRANSPORT_ERROR,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_Any_2_Terminated_X_transportError,"tsip_dialog_generic_Any_2_Terminated_X_transportError"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_generic_actions_e.ERROR,tsip_dialog_generic_states_e.TERMINATED,tsip_dialog_generic_Any_2_Terminated_X_Error,"tsip_dialog_generic_Any_2_Terminated_X_Error"))}tsip_dialog_generic.prototype.signal_ao=function(a,c,b){var d;switch(this.e_type){case tsip_dialog_type_e.MESSAGE:var d=new tsip_event_message(this.get_session(),a,c,b,tsip_event_message_type_e.AO_MESSAGE);return d.signal();case tsip_dialog_type_e.PUBLISH:var d=new tsip_event_publish(this.get_session(),a,c,b,tsip_event_publish_type_e.AO_PUBLISH);return d.signal();case tsip_dialog_type_e.SUBSCRIBE:var d=new tsip_event_subscribe(this.get_session(),a,c,b,tsip_event_subscribe_type_e.AO_SUBSCRIBE);return d.signal()}tsk_utils_log_error("not implemented");return -1};tsip_dialog_generic.prototype.signal_i=function(a,c,b){var d;switch(this.e_type){case tsip_dialog_type_e.MESSAGE:if(b.is_message()){var d=new tsip_event_message(this.get_session(),a,c,b,tsip_event_message_type_e.I_MESSAGE);return d.signal()}break;case tsip_dialog_type_e.SUBSCRIBE:if(b.is_notify()){var d=new tsip_event_subscribe(this.get_session(),a,c,b,tsip_event_subscribe_type_e.I_NOTIFY);return d.signal()}break}tsk_utils_log_error("not implemented");return -1};function __tsip_dialog_generic_timer_callback(b,a){var c=-1;if(b){if(b.o_timerRefresh==a){switch(b.e_type){case tsip_dialog_type_e.PUBLISH:c=b.fsm_act(tsip_dialog_generic_actions_e.O_PUBLISH,null,null);break;case tsip_dialog_type_e.SUBSCRIBE:c=b.fsm_act(tsip_dialog_generic_actions_e.O_SUBSCRIBE,null,null);break}}else{if(b.o_timerShutdown==a){c=b.fsm_act(tsip_dialog_generic_actions_e.SHUTDOWN,null,null)}}}return c}function __tsip_dialog_generic_event_callback(a,b,c){var d=-1;switch(b){case tsip_dialog_event_type_e.I_MSG:if(c){if(c.is_response()){if(c.is_1xx()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_1XX,c,null)}else{if(c.is_2xx()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_2XX,c,null)}else{if(c.is_response_xxx(401)||c.is_response_xxx(407)||c.is_response_xxx(421)||c.is_response_xxx(494)){d=a.fsm_act(tsip_dialog_generic_actions_e.I_401_407_421_494,c,null)}else{if(c.is_response_xxx(423)){d=a.fsm_act(tsip_dialog_generic_actions_e.I_423,c,null)}else{if(c.is_3456()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_300_to_699,c,null)}else{d=a.fsm_act(tsip_dialog_generic_actions_e.ERROR,c,null)}}}}}}else{if(c.is_message()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_MESSAGE,c,null)}else{if(c.is_options()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_OPTIONS,c,null)}else{if(c.is_notify()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_NOTIFY,c,null)}else{if(c.is_subscribe()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_SUBSCRIBE,c,null)}else{if(c.is_info()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_INFO,c,null)}else{if(c.is_publish()){d=a.fsm_act(tsip_dialog_generic_actions_e.I_PUBLISH,c,null)}}}}}}}}break;case tsip_dialog_event_type_e.CANCELED:d=a.fsm_act(tsip_dialog_generic_actions_e.CANCEL,c,null);break;case tsip_dialog_event_type_e.TERMINATED:case tsip_dialog_event_type_e.TIMEDOUT:case tsip_dialog_event_type_e.ERROR:case tsip_dialog_event_type_e.TRANSPORT_ERROR:d=a.fsm_act(tsip_dialog_generic_actions_e.TRANSPORT_ERROR,c,null);break}return d}function __tsip_dialog_generic_cond_is_dialogless(b,a){switch(b.e_type){case tsip_dialog_type_e.INFO:case tsip_dialog_type_e.MESSAGE:case tsip_dialog_type_e.OPTIONS:return true;default:return false}}function __tsip_dialog_generic_cond_is_dialogfull(b,a){return !__tsip_dialog_generic_cond_is_dialogless(b,a)}function __tsip_dialog_generic_cond_is_resp2message(b,a){return a.is_response_to_message()}function __tsip_dialog_generic_cond_is_message(b,a){return a.is_message()}function __tsip_dialog_generic_cond_is_disconnecting(b,a){return b.b_disconnecting}function __tsip_dialog_generic_cond_is_connecting(b,a){return !__tsip_dialog_generic_cond_is_disconnecting(b,a)}function __tsip_dialog_generic_cond_silent_hangup(b,a){return b.o_session.b_silent_hangup}function __tsip_dialog_generic_cond_not_silent_hangup(b,a){return !__tsip_dialog_generic_cond_silent_hangup(b,a)}function __tsip_dialog_generic_cond_silent_shutdown(b,a){return __tsip_dialog_generic_cond_silent_hangup(b,a)}function __tsip_dialog_generic_cond_not_silent_shutdown(b,a){return !__tsip_dialog_generic_cond_silent_shutdown(b,a)}function tsip_dialog_generic_InProgress_2_InProgress_X_1xx(a){var c=a[0];var b=a[1];return c.signal_ao(b.get_response_code(),b.get_response_phrase(),b)}function tsip_dialog_generic_InProgress_2_Terminated_X_2xx(a){var c=a[0];var b=a[1];return c.signal_ao(b.get_response_code(),b.get_response_phrase(),b)}function tsip_dialog_generic_InProgress_2_Connected_X_2xx(b){var e=b[0];var c=b[1];var a=(e.e_state==tsip_dialog_state_e.INITIAL);if((i_ret=e.update_with_response(c))!=0){return i_ret}if(e.e_type==tsip_dialog_type_e.PUBLISH){var d;if((d=c.get_header(tsip_header_type_e.SIP_ETag))){if(d.s_value){e.s_etag=d.s_value}else{tsk_utils_log_warn("SIP-ETag header without value: Is it a bug?")}}}e.set_action_curr(null);e.i_timerRefresh=e.get_newdelay(c);e.timer_schedule("generic","Refresh");e.signal_ao(c.get_response_code(),c.get_response_phrase(),c);if(a){e.signal(tsip_event_code_e.DIALOG_CONNECTED,"Connected")}return 0}function tsip_dialog_generic_InProgress_2_InProgress_X_401_407_421_494(a){var d=a[0];var b=a[1];var c;if((c=d.update_with_response(b))){d.signal_ao(b.get_response_code(),b.get_response_phrase(),b);d.set_last_error(b.get_response_code(),b.get_response_phrase(),b);return c}switch(d.e_type){case tsip_dialog_type_e.MESSAGE:return d.send_message();case tsip_dialog_type_e.PUBLISH:return d.send_publish();case tsip_dialog_type_e.SUBSCRIBE:return d.send_subscribe()}return 0}function tsip_dialog_generic_InProgress_2_Terminated_X_300_to_699(a){var c=a[0];var b=a[1];c.set_last_error(b.get_response_code(),b.get_response_phrase(),b);return c.signal_ao(b.get_response_code(),b.get_response_phrase(),b)}function tsip_dialog_generic_InProgress_2_Terminated_X_cancel(a){tsk_utils_log_error("Not implemented");return 0}function tsip_dialog_generic_Incoming_2_Terminated_X_accept(a){var e=a[0];var b=a[2];if(!e.o_last_iMessage){tsk_utils_log_error("Invalid state")}else{var c;var d=-1;e.set_action_curr(b);if((c=e.response_new(200,"OK",e.o_last_iMessage))){if((d=tsip_dialog.prototype.ApplyAction(c,b))==0){if((d=e.response_send(c))){tsk_utils_log_error("Failed to send SIP response.");return d}}}else{tsk_utils_log_error("Failed to create SIP response.");return -1}}return 0}function tsip_dialog_generic_Incoming_2_Connected_X_accept(a){tsk_utils_log_error("Not implemented");return 0}function tsip_dialog_generic_Incoming_2_Terminated_X_reject(a){tsk_utils_log_error("Not implemented");return 0}function __tsip_dialog_generic_Any_2_InProgress_X_hangup(a){var c=a[0];var b=a[2];c.set_action_curr(b);c.signal(tsip_event_code_e.DIALOG_TERMINATING,"Disconnecting...");c.b_disconnecting=true;switch(c.e_type){case tsip_dialog_type_e.PUBLISH:return c.send_publish();case tsip_dialog_type_e.SUBSCRIBE:return c.send_subscribe()}return 0}function __tsip_dialog_generic_Any_2_InProgress_X_shutdown(a){var b=a[0];b.timer_schedule("generic","Shutdown");b.signal(tsip_event_code_e.DIALOG_TERMINATING,"Disconnecting...");b.b_disconnecting=true;switch(b.e_type){case tsip_dialog_type_e.PUBLISH:return b.send_publish();case tsip_dialog_type_e.SUBSCRIBE:return b.send_subscribe()}return 0}function tsip_dialog_generic_Any_2_Terminated_X_transportError(a){tsk_utils_log_error("Not implemented");return 0}function tsip_dialog_generic_Any_2_Terminated_X_Error(a){tsk_utils_log_error("Not implemented");return 0}function __tsip_dialog_generic_onterm(a){tsk_utils_log_info("=== "+a.e_type.s_name+" Dialog terminated ===");a.timer_cancel("Refresh");a.timer_cancel("Shutdown");a.signal(tsip_event_code_e.DIALOG_TERMINATED,a.last_error.s_phrase?a.last_error.s_phrase:"Disconnected",a.last_error.o_message);return a.deinit()}if(!window.__b_release_mode){tsip_api_add_js_scripts("head","src/tinySIP/src/dialogs/tsip_dialog_generic__message.js","src/tinySIP/src/dialogs/tsip_dialog_generic__publish.js","src/tinySIP/src/dialogs/tsip_dialog_generic__subscribe.js")};