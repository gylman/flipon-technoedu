tsip_dialog.prototype.__i_timer_shutdown=3000;var tsip_dialog_type_e={UNKNOWN:{i_id:0,s_name:"Unknown"},INVITE:{i_id:1,s_name:"INVITE"},MESSAGE:{i_id:2,s_name:"MESSAGE"},INFO:{i_id:3,s_name:"INFO"},OPTIONS:{i_id:4,s_name:"OPTIONS"},PUBLISH:{i_id:5,s_name:"PUBLISH"},REGISTER:{i_id:6,s_name:"REGISTER"},SUBSCRIBE:{i_id:7,s_name:"SUBSCRIBE"}};var tsip_dialog_state_e={INITIAL:{i_id:0,s_name:"Initial"},EARLY:{i_id:1,s_name:"Early"},ESTABLISHED:{i_id:2,s_name:"Established"},TERMINATED:{i_id:3,s_name:"Terminated"}};var tsip_dialog_event_type_e={I_MSG:{i_id:0,s_name:"I_MSG"},O_MSG:{i_id:1,s_name:"O_MSG"},TRANSAC_OK:{i_id:2,s_name:"TRANSAC_OK"},CANCELED:{i_id:3,s_name:"CANCELED"},TERMINATED:{i_id:4,s_name:"TERMINATED"},TIMEDOUT:{i_id:5,s_name:"TIMEDOUT"},ERROR:{i_id:6,s_name:"ERROR"},TRANSPORT_ERROR:{i_id:7,s_name:"TRANSPORT_ERROR"}};function tsip_dialog(){this.e_type=tsip_dialog_type_e.UNKNOWN;this.o_fsm=null;this.o_session=null;this.o_action_curr=null;this.e_state=tsip_dialog_state_e.INITIAL;this.b_initialized=false;this.b_running=false;this.last_error={};this.last_error.s_phrase=null;this.last_error.i_code=0;this.last_error.o_message=null;this.s_tag_local=null;this.o_uri_local=null;this.s_tag_remote=null;this.o_uri_remote=null;this.o_uri_remote_target=null;this.i_cseq_value=0;this.s_cseq_method=null;this.i_expires=0;this.s_callid=null;this.ao_hdr_record_routes=null;this.ao_challenges=null;this.fn_callback=null}tsip_dialog.prototype.init=function(b,e,d,c,a){if(this.b_initialized){tsk_utils_log_error("Dialog already initialized");return -2}this.e_state=tsip_dialog_state_e.INITIAL;this.e_type=b;this.ao_hdr_record_routes=new Array();this.ao_challenges=new Array();this.i_expires=tsip_session.prototype.__i_expires_default;var f=!tsk_string_is_null_or_empty(e);this.s_callid=f?e:tsk_string_random_uuid();if((this.o_session=d)){this.i_expires=d.i_expires;this.o_uri_local=f?d.o_uri_to:d.o_uri_from;if(d.o_uri_to){this.o_uri_remote=d.o_uri_to;this.o_uri_remote_target=d.o_uri_to}else{this.o_uri_remote=d.o_uri_from;this.o_uri_remote_target=d.o_stack.network.o_uri_realm}}this.s_tag_local=tsk_string_random(20);this.s_tag_remote=null;this.i_cseq_value=Math.floor((Math.random()*65535));this.o_fsm=new tsk_fsm(c,a,null,this);this.b_initialized=true;return 0};tsip_dialog.prototype.deinit=function(){this.get_layer_dialog().dialog_remove(this);this.get_layer_transac().cancel_by_dialog(this);this.b_initialized=false;return 0};tsip_dialog.prototype.compare=function(a){return tsip_dialog_compare(this,a)};tsip_dialog.prototype.request_new=function(g){if(!this.o_session||!this.o_session.o_stack||!g){tsk_utils_log_error("Invalid argument");return null}var x=null;var d=null;var e=null;var p=null;var n=-1;var c=null;var u=this.o_session;var q=u.o_stack;c=this.s_callid;d=this.o_uri_remote;e=this.o_uri_local;if(!this.ao_hdr_record_routes||this.ao_hdr_record_routes.length==0){p=this.o_uri_remote_target}else{o_uri_first_route=this.ao_hdr_record_routes[0].o_uri;if(tsk_params_have_param(o_uri_first_route.ao_params,"lr")){p=this.o_uri_remote_target;n=0}else{p=o_uri_first_route;n=1}}x=new tsip_request(g,p,e,d,c,this.i_cseq_value);x.o_hdr_To.s_tag=this.s_tag_remote;x.o_hdr_From.s_tag=this.s_tag_local;x.b_update=true;switch(x.line.request.e_type){case tsip_request_type_e.MESSAGE:case tsip_request_type_e.PUBLISH:case tsip_request_type_e.BYE:if(x.line.request.e_type==tsip_request_type_e.PUBLISH){x.add_header(new tsip_header_Expires(this.i_expires/1000))}for(var s=0;s<this.o_session.ao_caps.length;++s){var f=tsk_string_format("*;{0}",tsk_param_tostring(this.o_session.ao_caps[s]));if(f){x.add_header(new tsip_header_Dummy("Accept-Contact",f))}}break;default:var k=null;var t=null;if(x.line.request.e_type==tsip_request_type_e.OPTIONS||x.line.request.e_type==tsip_request_type_e.PUBLISH||x.line.request.e_type==tsip_request_type_e.REGISTER){k=tsk_string_format('m: "{1}"<{0}:{2}@{3}:{4};rtcweb-breaker={5}>;click2call={6};expires={7}\r\n',"sip",q.identity.s_display_name,e.s_user_name,"127.0.0.1",5060,q.network.b_rtcweb_enabled?"yes":"no",q.network.b_click2call_enabled?"yes":"no",Math.floor(this.i_expires/1000))}else{if(x.line.request.e_type==tsip_request_type_e.SUBSCRIBE){x.add_header(new tsip_header_Expires(this.i_expires/1000))}k=tsk_string_format('m: "{1}"<{0}:{2}@{3}:{4};rtcweb-breaker={5};click2call={6}>',"sip",q.identity.s_display_name,e.s_user_name,"127.0.0.1",5060,q.network.b_rtcweb_enabled?"yes":"no",q.network.b_click2call_enabled?"yes":"no");if(x.line.request.e_type==tsip_request_type_e.INVITE&&q.network.b_rtcweb_enabled){k+=";impi="+encodeURIComponent(q.identity.s_impi);k+=";ha1="+tsip_auth_digest_HA1(q.identity.s_impi,q.network.o_uri_realm.s_host,q.identity.s_password)}k+="\r\n"}t=tsip_header_Contact.prototype.Parse(k);if(t&&t.length>0){x.o_hdr_Contact=t[0]}if(x.o_hdr_Contact){for(var s=0;s<this.o_session.ao_caps.length;++s){tsk_params_add_param(x.o_hdr_Contact.ao_params,this.o_session.ao_caps[s])}}break}if(this.e_state==tsip_dialog_state_e.INITIAL&&this.ao_challenges.length==0){if(x.is_register()&&!q.security.b_earlyIMS){var b=q.network.o_uri_realm?q.network.o_uri_realm.s_host:"(null)";var w=tsip_uri_tostring(x.line.request.o_uri,false,false);var h=tsip_challenge.prototype.CreateEmptyHeaderAuthorization(q.identity.s_impi,b,w);x.add_header(h)}}else{if(this.ao_challenges.length>0){for(var s=0;s<this.ao_challenges.length;++s){var a=this.ao_challenges[s].create_header_authorization(x);if(a){x.add_header(a)}}}}if(!x.is_ack()&&!x.is_cancel()){x.o_hdr_CSeq.i_seq=++(this.i_cseq_value)}if(!x.is_register()){if(n!=-1){if(this.e_state==tsip_dialog_state_e.EARLY||this.e_state==tsip_dialog_state_e.ESTABLISHED){var o=-1;for(var s=0;s<this.ao_hdr_record_routes.length;++s){var v=this.ao_hdr_record_routes[s].o_uri;var m=null;if(++o<n||!v){continue}if((m=new tsip_header_Route(v))){for(var r=0;r<this.ao_hdr_record_routes[s].ao_params.length;++r){m.ao_params.push(this.ao_hdr_record_routes[s].ao_params[r])}x.add_header(m)}}}}else{if(this.e_state==tsip_dialog_state_e.INITIAL||this.e_state==tsip_dialog_state_e.EARLY){for(var s=0;s<q.ao_uri_service_routes.length;++s){x.add_header(new tsip_header_Service_Route(q.ao_uri_service_routes[s]))}}}}if(q.network.e_proxy_cscf_type==tsip_transport_type_e.WS||q.network.e_proxy_cscf_type==tsip_transport_type_e.WSS){var l=q.__get_proxy_outbound_uri_string();if(l){x.add_header(new tsip_header_Dummy("Route",l),true)}}for(var s=0;s<u.ao_headers.length;++s){x.add_header(u.ao_headers[s])}for(var s=0;s<q.ao_headers.length;++s){x.add_header(q.ao_headers[s])}this.add_common_headers(x);if(u.s_sigcomp_id){x.s_sigcomp_id=u.s_sigcomp_id}return x};tsip_dialog.prototype.response_new=function(b,f,c){var e;if((e=new tsip_response(b,f,c))){switch(c.line.request.e_type){case tsip_request_type_e.MESSAGE:case tsip_request_type_e.PUBLISH:break;default:if(e.o_hdr_To&&!e.o_hdr_To.s_tag){e.o_hdr_To.s_tag=this.s_tag_local}if(this.o_uri_local&&b>=101&&b<=299){var a;var d=tsk_string_format("m: <{0}:{1}@{2}:{3}>\r\n","sip",this.o_uri_local.s_user_name,"127.0.0.1",5060);var a=tsip_header_Contact.prototype.Parse(d);if(a!=null&&a.length>0){e.o_hdr_Contact=a[0];e.b_update=true}}break}if(this.get_session().s_sigcomp_id){e.s_sigcomp_id=this.get_session().s_sigcomp_id}}return e};tsip_dialog.prototype.response_send=function(c){var d=-1;var a=this.get_layer_transac();if(a){var b=a.find_server(c);if(b){setTimeout(function(){b.callback(tsip_transac_event_type_e.OUTGOING_MSG,c)},1);d=0}else{tsk_utils_log_error("Failed to find associated server transaction.")}}else{tsk_utils_log_error("Invalid parameter")}return d};tsip_dialog.prototype.get_session=function(){return this.o_session};tsip_dialog.prototype.get_stack=function(){if(this.o_session){return this.o_session.o_stack}return null};tsip_dialog.prototype.get_layer_transac=function(){var a=this.get_stack();if(a){return a.o_layer_transac}return null};tsip_dialog.prototype.get_layer_dialog=function(){var a=this.get_stack();if(a){return a.o_layer_dialog}return null};tsip_dialog.prototype.get_layer_transport=function(){var a=this.get_stack();if(a){return a.o_layer_transport}return null};tsip_dialog.prototype.request_send=function(c){if(!c){tsk_utils_log_error("Invalid argument");return -1}if(c.is_ack()){if(this.get_layer_transport().send(null,c)>0){return 0}return -2}var a=this.get_layer_transac();if(!a){tsk_utils_log_error("Invalid transac layer");return -1}var d=-1;var b=a.transac_new(true,c,this);if(b){switch(b.e_type){case tsip_transac_type_e.ICT:case tsip_transac_type_e.NICT:d=b.start(c);break}}return d};tsip_dialog.prototype.add_common_headers=function(c){var b=false;var d=null;var e=null;var a=this.get_stack();if(!c||!a){tsk_utils_log_error("Invalid argument");return -1}b=a.security.b_earlyIMS;d=a.identity.o_uri_pref;if(d){switch(c.line.request.e_type){case tsip_request_type_e.BYE:case tsip_request_type_e.INVITE:case tsip_request_type_e.OPTIONS:case tsip_request_type_e.SUBSCRIBE:case tsip_request_type_e.NOTIFY:case tsip_request_type_e.REFER:case tsip_request_type_e.MESSAGE:case tsip_request_type_e.PUBLISH:case tsip_request_type_e.REGISTER:if(!b||(b&&c.is_register())){c.add_header(new tsip_header_P_Preferred_Identity(d))}break}}if(e){switch(c.line.request.e_type){case tsip_request_type_e.BYE:case tsip_request_type_e.INVITE:case tsip_request_type_e.OPTIONS:case tsip_request_type_e.REGISTER:case tsip_request_type_e.SUBSCRIBE:case tsip_request_type_e.NOTIFY:case tsip_request_type_e.PRACK:case tsip_request_type_e.INFO:case tsip_request_type_e.UPDATE:case tsip_request_type_e.REFER:case tsip_request_type_e.MESSAGE:case tsip_request_type_e.PUBLISH:c.add_header(new tsip_header_P_Access_Network_Info(e));break}}return 0};tsip_dialog.prototype.get_action_curr=function(){return this.o_action_curr};tsip_dialog.prototype.set_action_curr=function(a){this.o_action_curr=a;return 0};tsip_dialog.prototype.set_last_error=function(a,c,b){this.last_error.i_code=a;this.last_error.s_phrase=c;this.last_error.o_message=b;return 0};tsip_dialog.prototype.signal=function(a,c,b){return tsip_event.prototype.Signal(tsip_event_type_e.DIALOG,this.o_session,a,c,b)};tsip_dialog.prototype.timer_schedule=function(T,N){this.timer_cancel(N);var This=this;var s_code=tsk_string_format("This.o_timer{1} = setTimeout(function(){ __tsip_dialog_{0}_timer_callback(This, This.o_timer{1})}, This.i_timer{1});",T,N);eval(s_code)};tsip_dialog.prototype.timer_cancel=function(N){var s_code=tsk_string_format("if(this.o_timer{0}) { clearTimeout(this.o_timer{0}); this.o_timer{0} = null; }",N);eval(s_code)};tsip_dialog.prototype.callback=function(b,a){if(this.fn_callback){return this.fn_callback(this,b,a)}tsk_utils_log_error("Invalid callback function");return -1};tsip_dialog.prototype.set_callback=function(a){this.fn_callback=a};tsip_dialog.prototype.fsm_act=function(b,c,a){if(!this.o_fsm){tsk_utils_log_error("Invalid argument");return -1}return this.o_fsm.act(b,this.o_fsm.get_usr_data(),c,this.o_fsm.get_usr_data(),c,a)};tsip_dialog.prototype.hangup=function(a){if(this.e_state==tsip_dialog_state_e.ESTABLISHED||(this.o_session&&this.o_session.b_server&&this.e_state==tsip_dialog_state_e.EARLY)||this.e_type!=tsip_dialog_type_e.INVITE){return this.fsm_act(tsip_action_type_e.HANGUP,null,a)}else{return this.fsm_act(tsip_action_type_e.CANCEL,null,a)}};tsip_dialog.prototype.shutdown=function(a){return this.fsm_act(tsip_action_type_e.SHUTDOWN,null,a)};tsip_dialog.prototype.update_with_response=function(c){if(!c||!c.is_response()||!c.o_hdr_To){tsk_utils_log_error("Invalid argument");return -1}var a=c.get_response_code();var g=c.o_hdr_To.s_tag;if(a==401||a==407||a==421||a==494){var f;f=(c.is_response_to_register()&&this.e_state==tsip_dialog_state_e.ESTABLISHED);return this.update_challenges(c,f)}else{if(100<a&&a<300){var b=this.e_state;if(a<=199){if(tsk_string_is_null_or_empty(c.o_hdr_To.s_tag)){tsk_utils_log_error("Invalid tag  parameter");return -1}b=tsip_dialog_state_e.EARLY}else{b=tsip_dialog_state_e.ESTABLISHED}if(!c.is_response_to_register()&&c.o_hdr_Contact&&c.o_hdr_Contact.o_uri){this.o_uri_remote_target=tsip_uri.prototype.Parse(tsip_uri_tostring(c.o_hdr_Contact.o_uri,true,false))}var d;var e;this.ao_hdr_record_routes.splice(0,this.ao_hdr_record_routes.length);for(d=0;(e=c.get_header_at(tsip_header_type_e.Record_Route,d));++d){this.ao_hdr_record_routes.push(e)}this.ao_hdr_record_routes.reverse();if(this.e_state==tsip_dialog_state_e.ESTABLISHED&&tsk_string_iequals(this.s_tag_remote,g)){return 0}else{if(!c.is_response_to_register()&&!c.is_response_to_publish()){this.s_tag_remote=g}}this.e_state=b;return 0}}return 0};tsip_dialog.prototype.update_with_invite=function(a){if(!a){tsk_utils_log_error("Invalid parameter");return -1}if(a.o_hdr_Contact&&a.o_hdr_Contact.o_uri){this.o_uri_remote_target=tsip_uri.prototype.Parse(tsip_uri_tostring(a.o_hdr_Contact.o_uri,true,false))}this.s_tag_remote=a.o_hdr_From?a.o_hdr_From.s_tag:"tag_doubango";if(a.o_hdr_From&&a.o_hdr_From.o_uri){this.o_uri_remote=a.o_hdr_From.o_uri}var b;var c;this.ao_hdr_record_routes.splice(0,this.ao_hdr_record_routes.length);for(b=0;(c=a.get_header_at(tsip_header_type_e.Record_Route,b));++b){this.ao_hdr_record_routes.push(c)}this.e_state=tsip_dialog_state_e.EARLY;return 0};tsip_dialog.prototype.update_challenges=function(b,d){var f=-1;var k;var h;var a;for(var e=0;(h=b.get_header_at(tsip_header_type_e.WWW_Authenticate,e));e++){var g=true;for(var c=0;c<this.ao_challenges.length;++c){k=this.ao_challenges[c];if(k.b_isproxy){continue}if(tsk_string_iequals(k.s_realm,h.s_realm)&&(h.b_stale||d)){if((f=k.update(h.s_scheme,h.s_realm,h.s_nonce,h.s_opaque,h.s_algorithm,h.s_qop))){return f}else{g=false;continue}}else{tsk_utils_log_error("Failed to handle new challenge");return -1}}if(g){if((k=new tsip_challenge(this.get_stack(),false,h.s_scheme,h.s_realm,h.s_nonce,h.s_opaque,h.s_algorithm,h.s_qop))){this.ao_challenges.push(k)}else{tsk_utils_log_error("Failed to handle new challenge");return -1}}}for(var e=0;(a=b.get_header_at(tsip_header_type_e.Proxy_Authenticate,e));e++){var g=true;for(var c=0;c<this.ao_challenges.length;++c){k=this.ao_challenges[c];if(!k.b_isproxy){continue}if(tsk_string_iequals(k.s_realm,a.s_realm)&&(a.b_stale||d)){if((f=k.update(a.s_scheme,a.s_realm,a.s_nonce,a.s_opaque,a.s_algorithm,a.s_qop))){return f}else{g=false;continue}}else{tsk_utils_log_error("Failed to handle new challenge");return -1}}if(g){if((k=new tsip_challenge(this.get_stack(),true,a.s_scheme,a.s_realm,a.s_nonce,a.s_opaque,a.s_algorithm,a.s_qop))){this.ao_challenges.push(k)}else{tsk_utils_log_error("Failed to handle new challenge");return -1}}}return 0};tsip_dialog.prototype.get_newdelay=function(a){var i=this.i_expires/1000;var e=i;var f;var h;var d=false;if(a.is_notify()){var b;if((b=a.get_header(tsip_header_type_e.Subscription_State))){if(b.i_expires>0){i=b.i_expires;d=true}}}if(!d&&(f=a.get_header(tsip_header_type_e.Expires))){i=f.i_value;d=true}for(h=0;!d&&(f=a.get_header_at(tsip_header_type_e.Contact,h));++h){var j=f;if(j.o_uri){var c=tsk_param_get_value_by_name(j.o_uri.ao_params,"transport");var g=this.get_stack().__get_contact_uri(c?c:"udp");if(g){if(tsk_string_equals(j.o_uri.s_user_name,g.s_user_name)&&tsk_string_equals(j.o_uri.s_host,g.s_host)&&j.o_uri.i_port==g.i_port){if(j.i_expires>=0){i=j.i_expires;d=false;break}}}}}e=(i>1200)?(i-600):(i>>1);return(e*1000)};tsip_dialog.prototype.ApplyAction=function(c,a){if(!c||!a){tsk_utils_log_error("Invalid argument");return -1}for(var b=0;b<a.ao_headers.length;++b){c.add_header(a.ao_headers[b])}if(a.line_resp.i_code&&a.line_resp.s_phrase&&c.is_response()){c.line.response.i_status_code=a.line_resp.i_code;c.line.response.s_reason_phrase=a.line_resp.s_phrase}if(a.o_content){c.add_content(a.o_content)}return 0};function tsip_dialog_compare(b,a){if(b&&a){if((b.s_callid==a.s_callid)&&((b.s_tag_local==a.s_tag_local))&&((b.s_tag_remote==a.s_tag_remote))){return 0}}return -1}if(!window.__b_release_mode){tsip_api_add_js_scripts("head","src/tinySIP/src/dialogs/tsip_dialog_generic.js","src/tinySIP/src/dialogs/tsip_dialog_invite.js","src/tinySIP/src/dialogs/tsip_dialog_register.js")};