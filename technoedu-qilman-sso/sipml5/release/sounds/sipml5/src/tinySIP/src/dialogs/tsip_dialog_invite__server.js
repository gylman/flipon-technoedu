tsip_dialog_invite.prototype.__ao_supported_options=["100rel","timer"];tsip_dialog_invite.prototype.init_server=function(){this.o_fsm.set(tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.STARTED,tsip_dialog_invite_actions_e.I_INVITE,__tsip_dialog_invite_cond_is_bad_extension,tsip_dialog_invite_states_e.TERMINATED,s0000_Started_2_Terminated_X_iINVITE,"s0000_Started_2_Terminated_X_iINVITE"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.STARTED,tsip_dialog_invite_actions_e.I_INVITE,__tsip_dialog_invite_cond_is_bad_content,tsip_dialog_invite_states_e.TERMINATED,s0000_Started_2_Terminated_X_iINVITE,"s0000_Started_2_Terminated_X_iINVITE"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.STARTED,tsip_dialog_invite_actions_e.I_INVITE,__tsip_dialog_invite_cond_is_toosmall,tsip_dialog_invite_states_e.STARTED,s0000_Started_2_Started_X_iINVITE,"s0000_Started_2_Started_X_iINVITE"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.STARTED,tsip_dialog_invite_actions_e.I_INVITE,__tsip_dialog_invite_cond_enable_100rel,tsip_dialog_invite_states_e.INPROGRESS,s0000_Started_2_InProgress_X_iINVITE,"s0000_Started_2_InProgress_X_iINVITE"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.STARTED,tsip_dialog_invite_actions_e.I_INVITE,tsip_dialog_invite_states_e.RINGING,s0000_Started_2_Ringing_X_iINVITE,"s0000_Started_2_Ringing_X_iINVITE"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.INPROGRESS,tsip_dialog_invite_actions_e.I_PRACK,__tsip_dialog_invite_cond_prack_matched,tsip_dialog_invite_states_e.RINGING,s0000_InProgress_2_Ringing_X_iPRACK,"s0000_InProgress_2_Ringing_X_iPRACK"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.INPROGRESS,tsip_dialog_invite_actions_e.I_UPDATE,tsip_dialog_invite_states_e.INPROGRESS,s0000_InProgress_2_InProgress_X_iUPDATE,"s0000_InProgress_2_InProgress_X_iUPDATE"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.INPROGRESS,tsip_dialog_invite_actions_e.I_CANCEL,tsip_dialog_invite_states_e.TERMINATED,s0000_Inprogress_2_Terminated_X_iCANCEL,"s0000_Inprogress_2_Terminated_X_iCANCEL"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.RINGING,tsip_dialog_invite_actions_e.I_PRACK,__tsip_dialog_invite_cond_prack_matched,tsip_dialog_invite_states_e.RINGING,s0000_Ringing_2_Ringing_X_iPRACK,"s0000_Ringing_2_Ringing_X_iPRACK"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.RINGING,tsip_dialog_invite_actions_e.ACCEPT,tsip_dialog_invite_states_e.CONNECTED,s0000_Ringing_2_Connected_X_Accept,"s0000_Ringing_2_Connected_X_Accept"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.RINGING,tsip_dialog_invite_actions_e.REJECT,tsip_dialog_invite_states_e.TERMINATED,s0000_Ringing_2_Terminated_X_Reject,"s0000_Ringing_2_Terminated_X_Reject"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.RINGING,tsip_dialog_invite_actions_e.I_CANCEL,tsip_dialog_invite_states_e.TERMINATED,s0000_Ringing_2_Terminated_X_iCANCEL,"s0000_Ringing_2_Terminated_X_iCANCEL"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.TIMER_100REL,tsk_fsm.prototype.__i_state_any,s0000_Any_2_Any_X_timer100rel,"s0000_Any_2_Any_X_timer100rel"))};function __tsip_dialog_invite_cond_is_bad_extension(h,g){var e;var d,c,b;for(d=0;(e=g.get_header_at(tsip_header_type_e.Require,d));++d){var f=false;var a=null;for(b=0;b<e.as_options.length;++b){f=true;a=e.as_options[b];for(c=0;a&&c<tsip_dialog_invite.prototype.__ao_supported_options.length;++c){if(tsk_string_iequals(a,tsip_dialog_invite.prototype.__ao_supported_options[c])){f=false;break}}if(f){break}}if(f&&a){h.send_unsupported(g,a);return true}}return false}function __tsip_dialog_invite_cond_is_bad_content(f,c){var d;var a;var e=(f.e_state==tsip_dialog_state_e.initial&&!c.has_content());var b=f.o_msession_mgr&&!f.o_msession_mgr.has_ro();if((d=f.process_ro(c,b))){d=f.send_error(c,488,"Not Acceptable",'SIP; cause=488; text="Bad content"');return true}return false}function __tsip_dialog_invite_cond_is_toosmall(d,a){if(d.get_session().media.timers.i_timeout&&(a.is_supported("timer")||a.is_required("timer"))){var b;if((b=a.get_header(tsip_header_type_e.Session_Expires))){if(b.i_delta_seconds<TSIP_SESSION_EXPIRES_MIN_VALUE){d.stimers.i_minse=TSIP_SESSION_EXPIRES_MIN_VALUE;d.send_response(a,422,"Session Interval Too Small",false);return true}else{var c;d.stimers.i_timeout=b.i_delta_seconds;d.stimers.s_refresher=b.b_refresher_uas?"uas":"uac";d.stimers.b_is_refresher=tsk_string_iequals(d.stimers.s_refresher,"uas");if((c=a.get_header(tsip_header_type_e.Min_SE))){d.stimers.i_minse=c.i_value}}}}return false}function __tsip_dialog_invite_cond_enable_100rel(b,a){return((a.is_supported("100rel")&&b.supported.b_100rel)||a.is_required("100rel"))}function __tsip_dialog_invite_cond_prack_matched(c,b){var a;if(!c.o_last_o1xxrel){return false}if((a=b.get_header(tsip_header_type_e.RAck))){if((a.i_seq==c.i_rseq)&&(tsk_string_iequals(a.s_method,c.o_last_o1xxrel.o_hdr_CSeq.s_method))&&(a.i_cseq==c.o_last_o1xxrel.o_hdr_CSeq.i_seq)){c.i_rseq++;return true}else{tsk_utils_log_warn("Failed to match PRACK request")}}return false}function s0000_Started_2_Terminated_X_iINVITE(a){return 0}function s0000_Started_2_Started_X_iINVITE(a){var b=a[0];b.b_is_client=false;return 0}function s0000_Started_2_InProgress_X_iINVITE(a){var c=a[0];var b=a[1];c.b_is_client=false;c.o_last_iInvite=b;c.b_support_update=b.is_allowed("UPDATE");c.update_with_invite(b);c.i_rseq=Math.floor((Math.random()*65535));c.require.b_100rel=true;return c.send_response(b,183,"Session in Progress",true)}function s0000_Started_2_Ringing_X_iINVITE(a){var d=a[0];var b=a[1];var c;d.b_is_client=false;d.o_last_iInvite=b;d.b_support_update=b.is_allowed("UPDATE");if(d.o_last_iInvite&&(d.o_last_iInvite.is_supported("100rel")||d.o_last_iInvite.is_required("100rel"))&&d.supported.b_100rel){d.require.b_100rel=true}if(d.get_session().media.timers.i_timeout){if((c=b.get_header(tsip_header_type_e.Session_Expires))){d.stimers.timer.i_timeout=c.i_delta_seconds;d.stimers.s_refresher=c.s_refresher_uas?"uas":"uac";d.stimers.b_is_refresher=c.s_refresher_uas;d.require.b_timer=true}}d.update_with_invite(b);d.send_response(b,180,"Ringing",false);d.signal_invite(tsip_event_invite_type_e.I_NEW_CALL,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Call",b);return 0}function s0000_InProgress_2_Ringing_X_iPRACK(a){var e=a[0];var c=a[1];var d;e.timer_cancel("100Rel");if((d=e.send_response(c,200,"OK",false))==0){++e.i_rseq}if(e.o_msession_mgr&&!e.o_msession_mgr.sdp.o_ro){if(c.has_content()){var b=e.o_msession_mgr&&!e.o_msession_mgr.has_ro();if((d=e.process_ro(c,b))){d=e.send_error(e.o_last_iInvite,488,"Not Acceptable",'SIP; cause=488; text="Bad content"');return -4}}else{d=e.send_error(e.o_last_iInvite,488,"Not Acceptable",'SIP; cause=488; text="Offer expected in the PRACK"');return -3}}d=e.send_response(e.o_last_iInvite,180,"Ringing",false);e.signal_invite(tsip_event_invite_type_e.I_NEW_CALL,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Call",c);return d}function s0000_InProgress_2_InProgress_X_iUPDATE(a){tsk_utils_log_error("Not implemented");return 0}function s0000_Inprogress_2_Terminated_X_iCANCEL(a){tsk_utils_log_error("Not implemented");return 0}function s0000_Ringing_2_Ringing_X_iPRACK(a){var d=a[0];var b=a[1];var c;if(!d.o_last_iInvite){return 0}d.timer_cancel("100Rel");c=d.send_response(b,200,"OK",false);d.signal_invite(tsip_event_invite_type_e.I_REQUEST,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",b);return c}function s0000_Ringing_2_Connected_X_Accept(a){var d=a[0];var b=a[2];var c;d.e_state=tsip_dialog_state_e.ESTABLISHED;d.set_action_curr(b);if(d.o_msession_mgr&&!d.o_msession_mgr.is_started()&&(d.o_msession_mgr.has_lo()&&d.o_msession_mgr.has_ro())){c=d.o_msession_mgr.start()}d.timer_cancel("100Rel");c=d.send_response(d.o_last_iInvite,200,"OK",true);if(d.stimers.i_timeout){if(d.stimers.b_is_refresher){tsk_utils_log_error("Not implemented")}else{tsk_utils_log_error("Not implemented")}}d.signal(tsip_event_code_e.DIALOG_CONNECTED,"In call");if(!d.o_msession_mgr.has_lo()){}return c}function s0000_Ringing_2_Terminated_X_Reject(b){var f;var a;var e;var d;var g=b[0];var c=b[2];g.set_action_curr(c);g.timer_cancel("100Rel");a=(c&&c.line_resp.i_code>=300)?c.line_resp.i_code:603;e=(c&&c.line_resp.s_phrase)?c.line_resp.s_phrase:"Decline";d=tsk_string_format('SIP; cause={0}; text="{1}"',a,e);f=g.send_error(g.o_last_iInvite,a,e,d);g.set_last_error(a,"Call Rejected");return f}function s0000_Ringing_2_Terminated_X_iCANCEL(a){var e=a[0];var b=a[1];var c;var d;if((c=e.response_new(200,"OK",b))){d=e.get_stack().o_layer_transport.send(null,c)}d=e.send_error(e.o_last_iInvite,487,"Request Cancelled",'SIP; cause=487; text="Request Cancelled"');e.set_last_error(487,"Request Cancelled");e.signal_invite(tsip_event_invite_type_e.I_REQUEST,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",b);return d}function s0000_Any_2_Any_X_timer100rel(a){var c=a[0];var b;if(!c.o_last_o1xxrel){return 0}if((c.i_timer100Rel<<=1)>=(c.get_stack().o_timers.getA()<<6)){tsk_utils_log_error("Sending reliable 1xx failed");return -2}if((b=c.response_send(c.o_last_o1xxrel))){return b}else{c.timer_schedule("invite","100Rel")}return b};