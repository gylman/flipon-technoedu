tsip_stack.prototype.on_event_stack=null;tsip_stack.prototype.on_event_dialog=null;tsip_stack.prototype.on_event_invite=null;tsip_stack.prototype.on_event_message=null;tsip_stack.prototype.on_event_publish=null;tsip_stack.prototype.on_event_subscribe=null;var tsip_stack_param_type_e={DISPLAY_NAME:0,IMPU:1,PREFERRED_ID:2,IMPI:3,PASSWORD:4,SIGCOMP:10,SIGCOMP_ADD_COMPARTMENT:11,SIGCOMP_REMOVE_COMPARTMENT:12,REALM:20,LOCAL_IP:21,LOCAL_PORT:22,AOR:23,DISCOVERY_NAPTR:24,DISCOVERY_DHCP:25,PROXY_CSCF:26,DNSSERVER:27,MODE_SERVER:28,PROXY_OUTBOUND:30,WEBSOCKET_SERVER_URL:31,ICE_SERVERS:32,ENABLE_RTCWEB_BREAKER:33,ENABLE_CLICK2CALL:34,ENABLE_SECURE_TRANSPORT:35,EARLY_IMS:40,SECAGREE_IPSEC:41,SECAGREE_TLS:42,AMF:43,OPERATOR_ID:44,TLS_CERTS:45,IPSEC_PARAMS:46,HEADER:50,STUN_SERVER:60,STUN_CRED:61,CACHE_MEDIA_STREAM:70,BANDWIDTH:71,VIDEO_SIZE:72,USERDATA:80};var tsip_transport_state_e={NONE:-1,STARTING:0,STARTED:1,STOPPING:3,STOPPED:4};function tsip_stack(c,b,e,f,g){if(!c||!b||!e){tsk_utils_log_error("Invalid argument");return null}var d=tsip_uri.prototype.Parse(e);if(!d){tsk_utils_log_error("'"+e+"' is not a valid IMPU Uri");return null}if(tsk_string_index_of(c,c.length,"sip:")!=0&&tsk_string_index_of(c,c.length,"sips:")!=0){c=tsk_string_format("sip:{0}",c)}var a=tsip_uri.prototype.Parse(c);if(!a){tsk_utils_log_error("'"+c+"' is not a valid realm");return null}this.e_state=tsip_transport_state_e.NONE;this.identity={};this.identity.s_display_name=d.s_user_name;this.identity.o_uri_impu=d;this.identity.o_uri_pref=null;this.identity.s_impi=b;this.identity.s_password=null;this.network={};this.network.o_transport=null;this.network.s_transport="ws";this.network.s_local_ip=null;this.network.i_local_port=0;this.network.s_proxy_cscf_host=f;this.network.i_proxy_cscf_port=g;this.network.e_proxy_cscf_type=tsk_utils_have_webrtc4all()?tsip_transport_type_e.UDP:tsip_transport_type_e.WS;this.network.o_uri_realm=a;this.network.s_proxy_outbound_host=null;this.network.i_proxy_outbound_port=5060;this.network.e_proxy_outbound_type=this.network.e_proxy_cscf_type;this.network.s_websocket_server_url=null;this.network.ao_ice_servers=null;this.network.b_rtcweb_enabled=false;this.network.b_click2call_enabled=false;this.network.aor={};this.network.aor.s_ip=null;this.network.aor.i_port=0;this.security={};this.security.b_earlyIMS=true;this.security.tls={};this.security.tls.s_ca=null;this.security.tls.s_pbk=null;this.security.tls.s_pvk=null;this.natt={};this.natt.stun={};this.natt.stun.s_ip=null;this.natt.stun.i_port=0;this.natt.stun.s_login=null;this.natt.stun.s_pwd=null;this.media={};this.media.b_cache_stream=false;this.media.o_bandwidth={audio:undefined,video:undefined};this.media.o_video_size={minWidth:undefined,minHeight:undefined,maxWidth:undefined,maxHeight:undefined};this.o_timers=new tsip_timers();this.ao_sessions=new Array();this.ao_headers=new Array();this.o_usr_data=null;this.ao_uri_paths=new Array();this.ao_uri_service_routes=new Array();this.ao_uri_associated_uris=new Array();this.o_layer_dialog=new tsip_dialog_layer(this);this.o_layer_transac=new tsip_transac_layer(this);this.o_layer_transport=new tsip_transport_layer(this);this.__set(Array.prototype.slice.call(arguments,5))}tsip_stack.prototype.start=function(){if(this.e_state==tsip_transport_state_e.STARTED){tsk_utils_log_warn("Already started");return 0}else{if(this.e_state==tsip_transport_state_e.STARTING){this.stop()}}if(!this.network.s_proxy_cscf_host){tsk_utils_log_error("'"+this.network.s_proxy_cscf_host+"' not valid as proxy host");return -2}tsk_utils_log_info("SIP stack start: proxy='"+this.network.s_proxy_cscf_host+":"+this.network.i_proxy_cscf_port+"', realm='"+this.network.o_uri_realm+"', impi='"+this.identity.s_impi+"', impu='"+this.identity.o_uri_impu+"'");this.network.o_transport=this.o_layer_transport.transport_new(this.network.e_proxy_cscf_type,this.network.s_proxy_cscf_host,this.network.i_proxy_cscf_port,"SIP Transport",__tsip_stack_transport_callback);if(!this.network.o_transport){tsk_utils_log_error("Failed to create transport with type= "+this.network.e_proxy_cscf_type);return -2}this.e_state=tsip_transport_state_e.STARTING;this.signal(tsip_event_code_e.STACK_STARTING,"Stack starting");return this.network.o_transport.start()};tsip_stack.prototype.stop=function(b){var a=this;setTimeout(function(){switch(a.e_state){case tsip_transport_state_e.STOPPED:case tsip_transport_state_e.STOPPING:case tsip_transport_state_e.NONE:return 0;default:break}if(typeof b=="undefined"){b=tsip_dialog.prototype.__i_timer_shutdown}var l=0;var e=false;var f=false;var k;var d=(b<<1)/3;var j=j=new Date();for(var g=0;g<a.o_layer_dialog.ao_dialogs.length;++g){if(a.o_layer_dialog.ao_dialogs[g].e_type==tsip_dialog_type_e.REGISTER){++l;continue}if((k=a.o_layer_dialog.ao_dialogs[g].shutdown())==0){e=true}}var m=function(){if(e){do{if((a.o_layer_dialog.ao_dialogs.length<=l)){setTimeout(h,1);return}if((new Date()-j)>=d){setTimeout(h,1);return}}while(false)}setTimeout(m,1)};var h=function(){if(!f){if(l>0){l=0;for(var n=0;n<a.o_layer_dialog.ao_dialogs.length;++n){if(a.o_layer_dialog.ao_dialogs[n].e_type==tsip_dialog_type_e.REGISTER){if((k=a.o_layer_dialog.ao_dialogs[n].shutdown())==0){++l}}}}f=true}do{if(a.o_layer_dialog.ao_dialogs.length==0||(new Date()-j)>=b){setTimeout(c,1);return}}while(false);setTimeout(h,1)};var c=function(){if(a.o_layer_transport){a.o_layer_transport.stop()}a.signal(tsip_event_code_e.STACK_STOPPED,"Stack stopped")};if(e){m()}else{if(l){h()}else{c()}}},1);return 0};tsip_stack.prototype.set=function(){return this.__set(arguments)};tsip_stack.prototype.SetDisplayName=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.DISPLAY_NAME,a)};tsip_stack.prototype.SetPassword=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.PASSWORD,a)};tsip_stack.prototype.SetProxyCSCF=function(c,b,a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.PROXY_CSCF,c,b,a)};tsip_stack.prototype.SetProxyOutBound=function(c,b,a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.PROXY_OUTBOUND,c,b,a)};tsip_stack.prototype.SetProxyOutBoundUrl=function(a){if(!a){return tsip_stack.prototype.SetProxyOutBound(null,5060,tsip_transport_type_e.UDP)}var c=tsk_string_parse_url(a);if(!c||c.length<3){tsk_utils_log_error(a+" not valid as outbound proxy url");return null}var b;switch(c[0]){case"udp":default:b=tsip_transport_type_e.UDP;break;case"tcp":b=tsip_transport_type_e.TCP;break;case"tls":b=tsip_transport_type_e.TLS;break;case"dtls":b=tsip_transport_type_e.DTLS;break;case"sctp":b=tsip_transport_type_e.SCTP;break;case"ws":b=tsip_transport_type_e.WS;break;case"wss":b=tsip_transport_type_e.WSS;break}return tsip_stack.prototype.SetProxyOutBound(c[1],c[2],b)};tsip_stack.prototype.SetWebsocketServerUrl=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.WEBSOCKET_SERVER_URL,a)};tsip_stack.prototype.SetIceServers=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.ICE_SERVERS,a)};tsip_stack.prototype.SetMediaStreamCacheEnabled=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.CACHE_MEDIA_STREAM,a)};tsip_stack.prototype.SetBandwidth=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.BANDWIDTH,a)};tsip_stack.prototype.SetVideoSize=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.VIDEO_SIZE,a)};tsip_stack.prototype.SetRTCWebBreakerEnabled=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.ENABLE_RTCWEB_BREAKER,a)};tsip_stack.prototype.SetClick2CallEnabled=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.ENABLE_CLICK2CALL,a)};tsip_stack.prototype.SetSecureTransportEnabled=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.ENABLE_SECURE_TRANSPORT,a)};tsip_stack.prototype.SetEarlyIMSEnabled=function(a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.EARLY_IMS,a)};tsip_stack.prototype.SetHeader=function(b,a){return tsip_stack.prototype.SetAny(tsip_stack_param_type_e.HEADER,b,a)};tsip_stack.prototype.__set=function(ao_params){var o_curr;for(var i=0;i<ao_params.length;++i){o_curr=ao_params[i];if(!o_curr){continue}switch(o_curr.e_type){case tsip_stack_param_type_e.DISPLAY_NAME:this.identity.s_display_name=o_curr.ao_values[0];if(this.identity.o_uri_impu){this.identity.o_uri_impu.s_display_name=this.identity.s_display_name}break;case tsip_stack_param_type_e.PASSWORD:this.identity.s_password=o_curr.ao_values[0];break;case tsip_stack_param_type_e.PROXY_CSCF:this.network.s_proxy_cscf_host=o_curr.ao_values[0];this.network.i_proxy_cscf_port=o_curr.ao_values[1];this.network.e_proxy_cscf_type=o_curr.ao_values[2];break;case tsip_stack_param_type_e.PROXY_OUTBOUND:this.network.s_proxy_outbound_host=o_curr.ao_values[0];this.network.i_proxy_outbound_port=o_curr.ao_values[1];this.network.e_proxy_outbound_type=o_curr.ao_values[2];break;case tsip_stack_param_type_e.WEBSOCKET_SERVER_URL:this.network.s_websocket_server_url=o_curr.ao_values[0];if(this.network.s_websocket_server_url){if(this.network.s_websocket_server_url.indexOf("wss://")==0){this.network.e_proxy_cscf_type=tsip_transport_type_e.WSS}else{if(this.network.s_websocket_server_url.indexOf("ws://")==0){this.network.e_proxy_cscf_type=tsip_transport_type_e.WS}}}break;case tsip_stack_param_type_e.ICE_SERVERS:if(!tsk_string_is_null_or_empty(o_curr.ao_values[0])){try{if(o_curr.ao_values[0] instanceof String||typeof o_curr.ao_values[0]=="string"){eval("this.network.ao_ice_servers = "+o_curr.ao_values[0]+";")}else{if(o_curr.ao_values[0] instanceof Array||typeof o_curr.ao_values[0]=="array"){this.network.ao_ice_servers=o_curr.ao_values[0]}else{tsk_utils_log_warn(o_curr.ao_values[0]+" not valid as ICE servers")}}}catch(e){tsk_utils_log_error("Failed to set ICE servers:"+e)}}break;case tsip_stack_param_type_e.ENABLE_RTCWEB_BREAKER:this.network.b_rtcweb_enabled=!!o_curr.ao_values[0];break;case tsip_stack_param_type_e.ENABLE_CLICK2CALL:this.network.b_click2call_enabled=!!o_curr.ao_values[0];break;case tsip_stack_param_type_e.ENABLE_SECURE_TRANSPORT:if(o_curr.ao_values[0]&&this.network.e_proxy_cscf_type==tsip_transport_type_e.WS){this.network.e_proxy_cscf_type=tsip_transport_type_e.WSS}break;case tsip_stack_param_type_e.EARLY_IMS:this.security.b_earlyIMS=!!o_curr.ao_values[0];break;case tsip_stack_param_type_e.CACHE_MEDIA_STREAM:this.media.b_cache_stream=!!o_curr.ao_values[0];break;case tsip_stack_param_type_e.BANDWIDTH:this.media.o_bandwidth=o_curr.ao_values[0];break;case tsip_stack_param_type_e.VIDEO_SIZE:this.media.o_video_size=o_curr.ao_values[0];break;case tsip_stack_param_type_e.HEADER:if(o_curr.ao_values[1]){this.ao_headers.push(new tsip_header_Dummy(o_curr.ao_values[0],o_curr.ao_values[1]))}else{var i_index=tsip_header.prototype.IndexOfByName(this.ao_headers,o_curr.ao_values[0]);if(i_index!=-1){this.ao_headers.splice(i_index,1)}}break}}return 0};tsip_stack.prototype.__get_contact_uri=function(c){for(var b=0;b<this.o_layer_transport.ao_transports.length;++b){var a=this.o_layer_transport.ao_transports[b].get_uri(false);if(a){a.s_user_name=this.identity.o_uri_impu.s_user_name;return a}}return null};tsip_stack.prototype.__get_proxy_outbound_uri_string=function(){if(this.network.s_proxy_outbound_host){var a;switch(this.network.e_proxy_outbound_type){case tsip_transport_type_e.TCP:a="tcp";break;case tsip_transport_type_e.TLS:a="tls";break;case tsip_transport_type_e.SCTP:a="sctp";break;case tsip_transport_type_e.DTLS:a="dtls";break;case tsip_transport_type_e.WS:a="ws";break;case tsip_transport_type_e.WSS:a="wss";break;case tsip_transport_type_e.UDP:default:a="udp";break}return tsk_string_format("<sip:{0}:{1};lr;sipml5-outbound;transport={2}>",this.network.s_proxy_outbound_host,this.network.i_proxy_outbound_port,a)}return null};tsip_stack.prototype.SetAny=function(a){var b=new Object();b.e_type=a;b.ao_values=Array.prototype.slice.call(arguments,1);return b};tsip_stack.prototype.signal=function(a,c){if(this.on_event_stack){var b=this.on_event_stack;var d=new tsip_event(null,a,c,null,tsip_event_type_e.STACK);d.o_stack=this;setTimeout(function(){b(d)},1)}return 0};function __tsip_stack_transport_callback(b){var a=b.o_transport.o_stack;switch(b.e_type){case tsip_transport_event_type_e.STARTED:a.e_state=tsip_transport_state_e.STARTED;a.signal(tsip_event_code_e.STACK_STARTED,"Stack started");break;case tsip_transport_event_type_e.STOPPED:if(a.e_state==tsip_transport_state_e.STARTING){a.signal(tsip_event_code_e.STACK_FAILED_TO_START,"Failed to connet to the server")}else{a.signal(tsip_event_code_e.STACK_STOPPED,"Stack stopped")}a.e_state=tsip_transport_state_e.STOPPED;a.o_layer_transport.transport_remove(b.o_transport);break;case tsip_transport_event_type_e.ERROR:break}return 0};