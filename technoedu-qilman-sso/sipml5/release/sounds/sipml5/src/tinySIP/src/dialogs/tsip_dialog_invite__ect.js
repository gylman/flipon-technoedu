var x0400_Connected_2_Connected_X_fREFER=null;tsip_dialog_invite.prototype.init_ect=function(){this.o_fsm.set(tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.O_ECT,tsip_dialog_invite_states_e.O_ECT_INPROGRESS,x0400_Connected_2_oECTing_X_oECT,"x0400_Connected_2_oECTing_X_oECT"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.O_ECT_INPROGRESS,tsip_dialog_invite_actions_e.I_2XX,__tsip_dialog_invite_cond_is_resp2refer,tsip_dialog_invite_states_e.O_ECT_INPROGRESS,x0400_oECTing_2_oECTing_X_i2xx,"x0400_oECTing_2_oECTing_X_i2xx"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.O_ECT_INPROGRESS,tsip_dialog_invite_actions_e.I_300_to_699,__tsip_dialog_invite_cond_is_resp2refer,tsip_dialog_invite_states_e.CONNECTED,x0400_oECTing_2_Connected_X_i3456,"x0400_ECTing_2_Connected_X_i36"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.O_ECT_INPROGRESS,tsip_dialog_invite_actions_e.I_NOTIFY,__tsip_dialog_invite_cond_is_1xx_notify,tsip_dialog_invite_states_e.O_ECT_INPROGRESS,x0400_oECTing_2_oECTing_X_iNOTIFY,"x0400_oECTing_2_oECTing_X_iNOTIFY"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.O_ECT_INPROGRESS,tsip_dialog_invite_actions_e.I_NOTIFY,__tsip_dialog_invite_cond_is_23456_notify,tsip_dialog_invite_states_e.CONNECTED,x0400_oECTing_2_Connected_X_iNOTIFY,"x0400_oECTing_2_Connected_X_iNOTIFY"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.I_REFER,__tsip_dialog_invite_cond_is_f_refer,tsip_dialog_invite_states_e.CONNECTED,x0400_Connected_2_Connected_X_fREFER,"x0400_Connected_2_Connected_X_fREFER"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.I_REFER,tsip_dialog_invite_states_e.I_ECT_REQUESTED,x0400_Connected_2_iECTreq_X_iREFER,"x0400_Connected_2_iECTreq_X_iREFER"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.I_ECT_REQUESTED,tsip_dialog_invite_actions_e.I_ECT_REJECT,tsip_dialog_invite_states_e.CONNECTED,x0400_iECTreq_2_Connected_X_reject,"x0400_iECTreq_2_Connected_X_reject"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.I_ECT_REQUESTED,tsip_dialog_invite_actions_e.I_ECT_ACCEPT,tsip_dialog_invite_states_e.I_ECT_INPROGRESS,x0400_iECTreq_2_iECTing_X_accept,"x0400_iECTreq_2_iECTing_X_accept"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.I_ECT_INPROGRESS,tsip_dialog_invite_actions_e.I_ECT_LNOTIFY,__tsip_dialog_invite_cond_is_1xx_f_notify,tsip_dialog_invite_states_e.I_ECT_INPROGRESS,x0400_iECTing_2_iECTing_X_1xxfNOTIFY,"x0400_iECTing_2_iECTing_X_1xxfNOTIFY"),tsk_fsm_entry.prototype.Create(tsip_dialog_invite_states_e.I_ECT_INPROGRESS,tsip_dialog_invite_actions_e.I_ECT_LNOTIFY,__tsip_dialog_invite_cond_is_23456_f_notify,tsip_dialog_invite_states_e.CONNECTED,x0400_iECTing_2_Connected_X_23456fNOTIFY,"x0400_iECTing_2_Connected_X_23456fNOTIFY"))};tsip_dialog_invite.prototype.ect_send_notify=function(a,b){var e;var c=-1;if((e=this.request_new("NOTIFY"))){var d=tsk_string_format("{0} {1} {2}\r\n",tsip_message.prototype.__s_version_default,a,b);e.add_content(d,"message/sipfrag");c=this.request_send(e);if(c==0){this.signal_invite(tsip_event_invite_type_e.O_ECT_NOTIFY,a,b,e)}}else{tsk_utils_log_error("Failed to create request")}return c};tsip_dialog_invite.prototype.ect_send_refer=function(a){var e=0;var d;var b;if(!a){tsk_utils_log_error("Invalid parameter");return -1}if(!(b=tsip_uri.prototype.Parse(a))){tsk_utils_log_error("Failed to parse "+a);return -1}if((d=this.request_new("REFER"))){var c=new tsip_header_Referred_By(this.get_stack().identity.o_uri_impu);c.add_param("cid",tsk_string_random(11));d.add_headers(new tsip_header_Refer_To(b),c,new tsip_header_Refer_Sub(this.supported.b_refer_sub));if(this.supported.b_norefsub){d.add_headers(new tsip_header_Supported("norefersub"))}e=this.request_send(d)}return e};function x0400_Connected_2_oECTing_X_oECT(a){var c;var d=a[0];var b=a[2];c=d.ect_send_refer(b.ect.s_to);if(c==0){d.signal_invite(tsip_event_invite_type_e.O_ECT_TRYING,tsip_event_code_e.DIALOG_REQUEST_SENT,"Call Transfer Initiated",null)}return c}function x0400_oECTing_2_oECTing_X_i2xx(a){var d=a[0];var c=a[1];var b;b=c.get_header(tsip_header_type_e.Refer_Sub);if(b){this.supported.b_refer_sub=b.b_sub}if(c.is_required("norefersub")){this.require.b_norefsub=true}d.signal_invite(tsip_event_invite_type_e.O_ECT_ACCEPTED,c.get_response_code(),c.get_response_phrase(),c);return 0}function x0400_oECTing_2_Connected_X_i3456(a){var c=a[0];var b=a[1];c.signal_invite(tsip_event_invite_type_e.O_ECT_FAILED,b.get_response_code(),b.get_response_phrase(),b);return 0}function x0400_oECTing_2_oECTing_X_iNOTIFY(b){var e=b[0];var d=b[1];var a;if((a=__tsip_dialog_invite_get_sip_frag_msg(d))){var c=e.send_response(d,200,"OK",false);e.signal_invite(tsip_event_invite_type_e.O_ECT_NOTIFY,a.get_response_code(),a.get_response_phrase(),a);return c}return 0}var x0400_oECTing_2_Connected_X_iNOTIFY=x0400_oECTing_2_oECTing_X_iNOTIFY;function x0400_Connected_2_iECTreq_X_iREFER(a){var b=a[0];b.o_last_iRefer=a[1];b.send_response(b.o_last_iRefer,100,"Asking for Transfer",false);b.signal_invite(tsip_event_invite_type_e.I_ECT_REQUESTED,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",b.o_last_iRefer);return 0}function x0400_iECTreq_2_Connected_X_reject(b){var f=b[0];var c=b[2];var a=c.line_resp.i_code>=300?c.line_resp.i_code:603;var e=c.line_resp.s_phrase?c.line_resp.s_phrase:"Decline";var d=tsk_string_format('SIP; cause={0}; text="{1}"',a,e);return f.send_error(f.o_last_iRefer,a,e,d)}function x0400_iECTreq_2_iECTing_X_accept(a){var d;var e=a[0];var b=a[2];d=e.send_response(e.o_last_iRefer,202,"Transfering...",false);var c=e.o_last_iRefer.get_header(tsip_header_type_e.Refer_To);this.o_ss_transf=new tsip_session_invite(e.get_stack(),tsip_session.prototype.SetToStr(c.o_uri.tostring(false,false)),tsip_session.prototype.SetCaps("+sip.ice"));this.o_ss_transf.media.e_type=e.get_session().media.e_type;this.o_ss_transf.i_id_parent=e.get_session().get_id();tsip_event.prototype.Signal(tsip_event_invite_type_e.I_ECT_NEW_CALL,this.o_ss_transf,tsip_event_code_e.DIALOG_REQUEST_OUTGOING,"ECTing",e.o_last_iRefer);return this.o_ss_transf.call(this.o_ss_transf.media.e_type)}function x0400_iECTing_2_iECTing_X_1xxfNOTIFY(a){var c=a[0];var b=a[1];return c.ect_send_notify(b.get_response_code(),b.get_response_phrase())}function x0400_iECTing_2_Connected_X_23456fNOTIFY(b){var d=b[0];var c=b[1];var a=c.get_response_code();d.ect_send_notify(a,c.get_response_phrase());if(a>=200&&a<=299){d.signal_invite(tsip_event_invite_type_e.I_ECT_COMPLETED,c.get_response_code(),c.get_response_phrase(),d.o_last_iRefer);return d.send_bye()}else{d.signal_invite(tsip_event_invite_type_e.I_ECT_FAILED,c.get_response_code(),c.get_response_phrase(),d.o_last_iRefer);return 0}}function __tsip_dialog_invite_get_sip_frag_respcode(b){var a=__tsip_dialog_invite_get_sip_frag_msg(b);return a?a.get_response_code():0}function __tsip_dialog_invite_get_sip_frag_msg(d){if(!d){tsk_utils_log_error("Invalid parameter");return null}var a;if(d.has_content()&&tsk_string_iequals(d.get_content_type(),"message/sipfrag")){var b=d.get_content_as_string();if(b){if(b.lastIndexOf("\r\n")!=(b.length-2)){b+="\r\n"}b+="\r\n";var c=tsk_ragel_state_create();tsk_ragel_state_init_str(c,b);a=tsip_message.prototype.Parse(c,false);if(a&&!a.is_response()){tsk_utils_log_error("SipFrag doesn't contain response");return null}}}return a};