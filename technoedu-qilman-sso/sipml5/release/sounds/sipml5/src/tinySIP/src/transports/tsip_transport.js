var tsip_transport_type_e={WS:0,WSS:1,TCP:2,TLS:3,UDP:4,SCTP:5,DTLS:6};var tsip_transport_event_type_e={STARTED:0,STOPPED:1,ERROR:2};function tsip_transport(d,c,b,f,e,a){if(!c){tsk_utils_log_error("Invalid argument");return null}switch(d){case tsip_transport_type_e.WS:this.b_reliable=true;this.s_scheme="sip";this.s_protocol="ws";this.s_via_protocol="WS";this.s_service="SIP+D2W";this.o_ws=null;this.__start=function(){return __tsip_transport_ws_start(this)};this.__stop=function(){return __tsip_transport_ws_stop(this)};this.__have_socket=function(g){return __tsip_transport_ws_have_socket(this,g)};this.__send=function(h,g){return __tsip_transport_ws_send(this,h,g)};break;case tsip_transport_type_e.WSS:this.b_reliable=true;this.s_scheme="sips";this.s_protocol="wss";this.s_via_protocol="WSS";this.s_service="SIPS+D2W";this.o_ws=null;this.__start=function(){return __tsip_transport_ws_start(this)};this.__stop=function(){return __tsip_transport_ws_stop(this)};this.__have_socket=function(g){return __tsip_transport_ws_have_socket(this,g)};this.__send=function(h,g){return __tsip_transport_ws_send(this,h,g)};break;case tsip_transport_type_e.UDP:if(!tsk_utils_have_webrtc4all()){tsk_utils_log_error("Transport not supported");return null}this.b_reliable=false;this.s_scheme="sip";this.s_protocol="udp";this.s_via_protocol="UDP";this.s_service="SIP+D2U";this.o_transport=null;this.__start=function(){return __tsip_transport_webrtc4all_start(this)};this.__stop=function(){return __tsip_transport_webrtc4all_stop(this)};this.__have_socket=function(g){return __tsip_transport_webrtc4all_have_socket(this,g)};this.__send=function(h,g){return __tsip_transport_webrtc4all_send(this,h,g)};break;case tsip_transport_type_e.TCP:case tsip_transport_type_e.TLS:case tsip_transport_type_e.SCTP:case tsip_transport_type_e.DTLS:default:tsk_utils_log_error(d+" not supported as a valid SIP transport");return null}this.e_type=d;this.o_stack=c;this.s_host=b;this.i_port=f;this.s_description=e;this.fn_callback=a;this.b_started=false;return this}tsip_transport.prototype.get_layer=function(){return this.o_stack.o_layer_transport};tsip_transport.prototype.is_reliable=function(){return this.b_reliable};tsip_transport.prototype.start=function(){if(this.b_started){tsk_utils_log_warn("Already started");return 0}return this.__start()};tsip_transport.prototype.stop=function(){if(!this.b_started){tsk_utils_log_warn("Not started");return 0}return this.__stop()};tsip_transport.prototype.get_local_ip=function(){if(this.e_type==tsip_transport_type_e.WS||this.e_type==tsip_transport_type_e.WSS){return"df7jal23ls0d.invalid"}else{if(this.o_transport&&this.o_transport.localIP){return this.o_transport.localIP}}tsk_utils_log_error("Not implemented");return"127.0.0.1"};tsip_transport.prototype.get_local_port=function(){if(this.e_type==tsip_transport_type_e.WS||this.e_type==tsip_transport_type_e.WSS){return -1}else{if(this.o_transport&&this.o_transport.localPort){return this.o_transport.localPort}}tsk_utils_log_error("Not implemented");return 5060};tsip_transport.prototype.get_uri=function(d){var c=false;var a=tsk_string_format("{0}:{1}{2}{3}:{4};{5};transport={6}",this.s_scheme,c?"[":"",this.o_stack.network.aor.s_ip,c?"]":"",this.o_stack.network.aor.i_port,d?"lr":"",this.s_protocol);var b=tsip_uri.prototype.Parse(a);if(b){b.e_host_type=c?tsip_host_type_e.ipv6:tsip_host_type_e.ipv4}return b};tsip_transport.prototype.have_socket=function(a){return this.__have_socket(a)};tsip_transport.prototype.send=function(e,b,d,a){var c=null;if(b.is_request()&&(!b.is_ack()||(b.is_ack()&&!b.o_hdr_firstVia))&&!b.is_cancel()){this.message_addvia(e,b);this.message_update_aor(b);this.message_update(b)}else{if(b.is_response()){if(b.o_hdr_Contact){this.message_update_aor(b)}if(b.o_hdr_firstVia.i_rport==0){b.o_hdr_firstVia.i_rport=b.o_hdr_firstVia.i_port}}}c=b.toString();tsk_utils_log_info("SEND: "+c);return this.__send(c,c.length)};function tsip_transport_event(c,a,b,d){this.o_transport=c;this.e_type=a;this.s_description=b;this.o_data=d;return this}tsip_transport.prototype.signal=function(b,c,d){if(this.fn_callback){var a=this.fn_callback;var e=new tsip_transport_event(this,b,c,d);setTimeout(function(){a(e)},1)}return 0};tsip_transport.prototype.message_addvia=function(b,a){if(!a.o_hdr_firstVia){a.o_hdr_firstVia=new tsip_header_Via(tsip_header_Via.prototype.__s_proto_name_default,tsip_header_Via.prototype.__s_proto_version_default,this.s_via_protocol,this.get_local_ip(),this.get_local_port());a.o_hdr_firstVia.add_param("rport",null)}if(b){a.o_hdr_firstVia.s_branch=b}else{a.o_hdr_firstVia.s_branch=tsk_string_format("{0}{1}",tsip_transac.prototype.__magic_cookie,tsk_string_random(20))}return 0};tsip_transport.prototype.message_update_aor=function(a){if(!a.b_update){return 0}if(!this.o_stack.network.aor.s_ip&&!this.o_stack.network.aor.i_port){this.o_stack.network.aor.s_ip=this.get_local_ip();this.o_stack.network.aor.i_port=this.get_local_port()}if(a.o_hdr_Contact&&a.o_hdr_Contact.o_uri){a.o_hdr_Contact.o_uri.s_scheme=this.s_scheme;a.o_hdr_Contact.o_uri.s_host=this.o_stack.network.aor.s_ip;a.o_hdr_Contact.o_uri.i_port=this.o_stack.network.aor.i_port;tsk_params_add(a.o_hdr_Contact.o_uri.ao_params,"transport",this.s_protocol)}return 0};tsip_transport.prototype.message_update=function(a){if(!a.b_update){return 0}if(a.s_sigcomp_id){if(a.o_hdr_firstVia){a.o_hdr_firstVia.add_param("comp","sigcomp");a.o_hdr_firstVia.add_param("sigcomp-id",tsk_string_format('"{0}"',a.s_sigcomp_id))}if(a.o_hdr_Contact&&a.o_hdr_Contact.o_uri){tsk_params_add(a.o_hdr_Contact.o_uri.ao_params,"sigcomp-id",a.sigcomp_id)}}a.b_update=false;return 0};function __tsip_transport_ws_start(b){if(!b){tsk_utils_log_error("Invalid argument");return -1}var a=tsk_string_is_null_or_empty(b.o_stack.network.s_websocket_server_url)?tsk_string_format("{0}://{1}:{2}",b.s_protocol,b.s_host,b.i_port):b.o_stack.network.s_websocket_server_url;tsk_utils_log_info("Connecting to '"+a+"'");b.o_ws=new WebSocket(a,"sip");b.o_ws.binaryType="arraybuffer";b.o_ws.o_transport=b;b.o_ws.onopen=__tsip_transport_ws_onopen;b.o_ws.onclose=__tsip_transport_ws_onclose;b.o_ws.onmessage=__tsip_transport_ws_onmessage;b.o_ws.onerror=__tsip_transport_ws_onerror;return 0}function __tsip_transport_ws_stop(a){if(!a){tsk_utils_log_error("Invalid argument");return -1}if(a.o_ws){a.o_ws.close()}return 0}function __tsip_transport_ws_have_socket(a,b){return a.o_ws==b}function __tsip_transport_ws_send(a,c,b){if(!a.o_ws){tsk_utils_log_error("Invalid state");return 0}a.o_ws.send(c);return b}function __tsip_transport_ws_onopen(a){tsk_utils_log_info("__tsip_transport_ws_onopen");this.o_transport.b_started=true;this.o_transport.signal(tsip_transport_event_type_e.STARTED,a.reason,null)}function __tsip_transport_ws_onclose(a){tsk_utils_log_info("__tsip_transport_ws_onclose");this.o_transport.b_started=false;this.o_transport.signal(tsip_transport_event_type_e.STOPPED,a.reason,null)}function __tsip_transport_ws_onmessage(a){tsk_utils_log_info("__tsip_transport_ws_onmessage");var b=tsk_ragel_state_create();if(typeof(a.data)=="string"){tsk_ragel_state_init_str(b,a.data)}else{tsk_ragel_state_init_ai(b,a.data)}var c=tsip_message.prototype.Parse(b,true);if(c){tsk_utils_log_info("recv="+c);c.o_socket=this;return this.o_transport.get_layer().handle_incoming_message(c)}else{tsk_utils_log_error("Failed to parse message: "+a.data);return -1}}function __tsip_transport_ws_onerror(a){tsk_utils_log_info("__tsip_transport_ws_onerror");this.o_transport.signal(tsip_transport_event_type_e.ERROR,a.reason,null)}function __tsip_transport_webrtc4all_start(o_self){if(!o_self){tsk_utils_log_error("Invalid argument");return -1}var b_isInternetExplorer=(WebRtc4all_GetType()==WebRtcType_e.IE);var s_url=tsk_string_is_null_or_empty(o_self.o_stack.network.s_proxy_outbound_host)?tsk_string_format("{0}://{1}:{2}",o_self.s_protocol,o_self.s_host,o_self.i_port):tsk_string_format("{0}://{1}:{2}",o_self.s_protocol,o_self.o_stack.network.s_proxy_outbound_host,o_self.o_stack.network.i_proxy_outbound_port);tsk_utils_log_info("Connecting to '"+s_url+"'");if(b_isInternetExplorer){o_self.o_transport=new ActiveXObject("webrtc4ie.NetTransport");eval("function o_self.o_transport::OnEvent(i_type, s_data) { return __tsip_transport_webrtc4all_onevent (o_self, i_type, s_data); }")}else{o_self.o_transport=WebRtc4npapi.createNetTransport();o_self.o_transport.opaque=o_self;o_self.o_transport.setCallbackFuncName("__tsip_transport_webrtc4all_onevent")}try{if(o_self.o_stack.network.s_proxy_outbound_host&&o_self.o_stack.network.i_proxy_outbound_port){o_self.s_host=o_self.o_stack.network.s_proxy_outbound_host;o_self.i_port=o_self.o_stack.network.i_proxy_outbound_port}else{o_self.o_transport.SetDomain(o_self.o_stack.network.o_uri_realm.s_host)}o_self.o_transport.Start(b_isInternetExplorer?WebRtc4all_GetLooper():0);if(o_self.o_transport.defaultDestAddr&&o_self.o_transport.defaultDestPort){o_self.s_host=o_self.o_transport.defaultDestAddr;o_self.i_port=o_self.o_transport.defaultDestPort;tsk_utils_log_info("Transport default destination="+o_self.s_host+":"+o_self.i_port)}o_self.b_started=true;o_self.signal(tsip_transport_event_type_e.STARTED,"Network transport started",null)}catch(e){tsk_utils_log_error(e);return -1}return 0}function __tsip_transport_webrtc4all_stop(a){if(!a){tsk_utils_log_error("Invalid argument");return -1}if(a.o_transport){a.o_transport.Stop()}return 0}function __tsip_transport_webrtc4all_have_socket(a,b){return a.o_transport==b}function __tsip_transport_webrtc4all_send(a,c,b){if(!a.o_transport){tsk_utils_log_error("Invalid state");return 0}a.o_transport.SendTo(c,a.s_host,a.i_port);return b}function __tsip_transport_webrtc4all_onevent(a,e,c){tsk_utils_log_info("__tsip_transport_webrtc4all_onevent");if(c){var b=tsk_ragel_state_create();tsk_ragel_state_init_str(b,c);var d=tsip_message.prototype.Parse(b,true);if(d){tsk_utils_log_info("RECV="+d.toString());d.o_socket=a.o_transport;return a.get_layer().handle_incoming_message(d)}else{tsk_utils_log_error("Failed to parse message: "+evt.data);return -1}}};