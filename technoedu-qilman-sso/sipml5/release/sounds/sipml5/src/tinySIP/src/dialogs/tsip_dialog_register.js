tsip_dialog_register.prototype=Object.create(tsip_dialog.prototype);tsip_dialog_register.prototype.__b_debug_state_machine=true;var tsip_dialog_register_actions_e={ACCEPT:tsip_action_type_e.ACCEPT,REJECT:tsip_action_type_e.REJECT,HANGUP:tsip_action_type_e.HANGUP,O_REGISTER:tsip_action_type_e.REGISTER,CANCEL:tsip_action_type_e.CANCEL,SHUTDOWN:tsip_action_type_e.SHUTDOWN,I_1XX:10001,I_2XX:10002,I_401_407_421_494:10003,I_423:10004,I_300_to_699:10005,I_REGISTER:20000,SHUTDOWN_TIMEDOUT:30000,TRANSPORT_ERROR:30001,ERROR:30002};var tsip_dialog_register_states_e={STARTED:0,INPROGRESS:1,INCOMING:2,CONNECTED:3,TERMINATED:4};function tsip_dialog_register(b,a){tsip_dialog.call(this);this.o_last_iRegister=null;this.b_unregistering=false;this.b_is_server=false;this.o_timerRefresh=null;this.o_timerShutdown=null;this.i_timerShutdown=(tsip_dialog.prototype.__i_timer_shutdown<<1)/3;this.init(tsip_dialog_type_e.REGISTER,a,b,tsip_dialog_register_states_e.STARTED,tsip_dialog_register_states_e.TERMINATED);this.set_callback(__tsip_dialog_register_event_callback);this.o_fsm.set_debug_enabled(tsip_dialog_register.prototype.__b_debug_state_machine);this.o_fsm.set_onterm_callback(__tsip_dialog_register_onterm,this);this.o_fsm.set(tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.STARTED,tsip_dialog_register_actions_e.O_REGISTER,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_Started_2_InProgress_X_oRegister,"tsip_dialog_register_Started_2_InProgress_X_oRegister"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.I_1XX,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_InProgress_2_InProgress_X_1xx,"tsip_dialog_register_InProgress_2_InProgress_X_1xx"),tsk_fsm_entry.prototype.Create(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.I_2XX,__tsip_dialog_register_cond_client_unregistering,tsip_dialog_register_states_e.TERMINATED,__tsip_dialog_register_InProgress_2_Terminated_X_2xx,"tsip_dialog_register_InProgress_2_Terminated_X_2xx"),tsk_fsm_entry.prototype.Create(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.I_2XX,__tsip_dialog_register_cond_client_registering,tsip_dialog_register_states_e.CONNECTED,__tsip_dialog_register_InProgress_2_Connected_X_2xx,"tsip_dialog_register_InProgress_2_Connected_X_2xx"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.I_401_407_421_494,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_InProgress_2_InProgress_X_401_407_421_494,"tsip_dialog_register_InProgress_2_InProgress_X_401_407_421_494"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.I_423,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_InProgress_2_InProgress_X_423,"tsip_dialog_register_InProgress_2_InProgress_X_423"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.I_300_to_699,tsip_dialog_register_states_e.TERMINATED,__tsip_dialog_register_InProgress_2_Terminated_X_300_to_699,"tsip_dialog_register_InProgress_2_Terminated_X_300_to_699"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.CANCEL,tsip_dialog_register_states_e.TERMINATED,__tsip_dialog_register_InProgress_2_Terminated_X_cancel,"tsip_dialog_register_InProgress_2_Terminated_X_cancel"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.HANGUP,tsip_dialog_register_states_e.TERMINATED,null,"tsip_dialog_register_InProgress_2_Terminated_X_hangup"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.INPROGRESS,tsip_dialog_register_actions_e.SHUTDOWN,tsip_dialog_register_states_e.TERMINATED,null,"tsip_dialog_register_InProgress_2_Terminated_X_shutdown"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_register_states_e.CONNECTED,tsip_dialog_register_actions_e.O_REGISTER,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_Connected_2_InProgress_X_oRegister,"tsip_dialog_register_Connected_2_InProgress_X_oRegister"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.HANGUP,__tsip_dialog_register_cond_not_silent_hangup,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_Any_2_InProgress_X_hangup,"tsip_dialog_register_Any_2_InProgress_X_hangup"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.HANGUP,__tsip_dialog_register_cond_silent_hangup,tsip_dialog_register_states_e.TERMINATED,null,"tsip_dialog_register_Any_2_InProgress_X_silenthangup"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.SHUTDOWN,__tsip_dialog_register_cond_not_silent_shutdown,tsip_dialog_register_states_e.INPROGRESS,__tsip_dialog_register_Any_2_InProgress_X_shutdown,"tsip_dialog_register_Any_2_InProgress_X_shutdown"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.SHUTDOWN,__tsip_dialog_register_cond_silent_shutdown,tsip_dialog_register_states_e.TERMINATED,null,"tsip_dialog_register_Any_2_InProgress_X_silentshutdown"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.SHUTDOWN_TIMEDOUT,tsip_dialog_register_states_e.TERMINATED,null,"tsip_dialog_register_shutdown_timedout"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.TRANSPORT_ERROR,tsip_dialog_register_states_e.TERMINATED,__tsip_dialog_register_Any_2_Terminated_X_transportError,"tsip_dialog_register_Any_2_Terminated_X_transportError"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_register_actions_e.ERROR,tsip_dialog_register_states_e.TERMINATED,__tsip_dialog_register_Any_2_Terminated_X_Error,"tsip_dialog_register_Any_2_Terminated_X_Error"))}tsip_dialog_register.prototype.signal_register=function(b,a,d,c){var e=new tsip_event_register(this.get_session(),a,d,c,b);return e.signal()};tsip_dialog_register.prototype.send_register=function(a){var b=null;var c=-1;if(this.b_unregistering){this.i_expires=0}if((b=this.request_new("REGISTER"))){if(this.e_state==tsip_dialog_state_e.INITIAL){b.add_header(new tsip_header_Supported("path"))}if(this.o_action_curr){tsip_dialog.prototype.ApplyAction(b,this.o_action_curr)}if((c=this.request_send(b))==0){this.signal(tsip_event_code_e.DIALOG_REQUEST_SENT,tsk_string_format("{0}REGISTER request successfully sent",this.b_unregistering?"un":""))}else{this.signal(tsip_event_code_e.DIALOG_TRANSPORT_ERROR,"Transport error")}}return c};function __tsip_dialog_register_timer_callback(b,a){var c=-1;if(b){if(b.o_timerRefresh==a){c=b.fsm_act(tsip_dialog_register_actions_e.O_REGISTER,null,null)}else{if(b.o_timerShutdown==a){c=b.fsm_act(tsip_dialog_register_actions_e.SHUTDOWN,null,null)}}}return c}function __tsip_dialog_register_event_callback(a,b,c){var d=-1;switch(b){case tsip_dialog_event_type_e.I_MSG:if(c){if(c.is_response()){if(c.is_1xx()){d=a.fsm_act(tsip_dialog_register_actions_e.I_1XX,c,null)}else{if(c.is_2xx()){d=a.fsm_act(tsip_dialog_register_actions_e.I_2XX,c,null)}else{if(c.is_response_xxx(401)||c.is_response_xxx(407)||c.is_response_xxx(421)||c.is_response_xxx(494)){d=a.fsm_act(tsip_dialog_register_actions_e.I_401_407_421_494,c,null)}else{if(c.is_response_xxx(423)){d=a.fsm_act(tsip_dialog_register_actions_e.I_423,c,null)}else{d=a.fsm_act(tsip_dialog_register_actions_e.ERROR,c,null)}}}}}else{if(c.is_register()){d=a.fsm_act(tsip_dialog_register_actions_e.I_REGISTER,c,null)}}}break;case tsip_dialog_event_type_e.CANCELED:d=a.fsm_act(tsip_dialog_register_actions_e.CANCEL,c,null);break;case tsip_dialog_event_type_e.TERMINATED:case tsip_dialog_event_type_e.TIMEDOUT:case tsip_dialog_event_type_e.ERROR:case tsip_dialog_event_type_e.TRANSPORT_ERROR:d=a.fsm_act(tsip_dialog_register_actions_e.TRANSPORT_ERROR,c,null);break}return d}function __tsip_dialog_register_cond_client_unregistering(b,a){return !b.b_is_server&&b.b_unregistering}function __tsip_dialog_register_cond_client_registering(b,a){return !__tsip_dialog_register_cond_client_unregistering(b,a)}function __tsip_dialog_register_cond_silent_hangup(b,a){return b.o_session.b_silent_hangup}function __tsip_dialog_register_cond_not_silent_hangup(b,a){return !__tsip_dialog_register_cond_silent_hangup(b,a)}function __tsip_dialog_register_cond_silent_shutdown(b,a){return __tsip_dialog_register_cond_silent_hangup(b,a)}function __tsip_dialog_register_cond_not_silent_shutdown(b,a){return !__tsip_dialog_register_cond_silent_shutdown(b,a)}function __tsip_dialog_register_Started_2_InProgress_X_oRegister(a){var c=a[0];var b=a[2];c.b_running=true;c.set_action_curr(b);c.signal(tsip_event_code_e.DIALOG_CONNECTING,"Connecting...");return c.send_register(true)}function __tsip_dialog_register_InProgress_2_InProgress_X_1xx(a){var c=a[0];var b=a[1];c.signal_register(tsip_event_register_type_e.AO_REGISTER,b.get_response_code(),b.get_response_phrase(),b);return c.update_with_response(b)}function __tsip_dialog_register_InProgress_2_Terminated_X_2xx(a){var c=a[0];var b=a[1];c.set_last_error(b.get_response_code(),b.get_response_phrase(),b);c.signal_register(tsip_event_register_type_e.AO_UNREGISTER,b.get_response_code(),b.get_response_phrase(),b);return 0}function __tsip_dialog_register_InProgress_2_Connected_X_2xx(a){var d=a[0];var b=a[1];var j;var h=(d.e_state==tsip_dialog_state_e.INITIAL);var e=d.get_stack();var i;var g;var c;var m;e.ao_uri_associated_uris.splice(0,e.ao_uri_associated_uris.length);e.ao_uri_service_routes.splice(0,e.ao_uri_service_routes.length);e.ao_uri_paths.splice(0,e.ao_uri_paths.length);for(i=0;(m=b.get_header_at(tsip_header_type_e.P_Associated_URI,i));++i){if(m.o_uri){e.ao_uri_associated_uris.push(m.o_uri)}}for(i=0;(c=b.get_header_at(tsip_header_type_e.Service_Route,i));++i){if(c.o_uri){e.ao_uri_service_routes.push(c.o_uri)}}for(i=0;(g=b.get_header_at(tsip_header_type_e.Path,i));++i){if(g.o_uri){e.ao_uri_paths.push(g.o_uri)}}if(h){var f=true;var l;var k=null;for(i=0;i<e.ao_uri_associated_uris.length;++i){if(!(l=e.ao_uri_associated_uris[i].o_uri)){continue}if(i==0){k=e.ao_uri_associated_uris[i].o_uri}if(e.identity.o_uri_pref.compare(l)==0){f=false;break}}if(f&&k){e.identity.o_uri_pref=k}}if((j=d.update_with_response(b))!=0){return j}d.set_action_curr(null);d.i_timerRefresh=d.get_newdelay(b);d.timer_schedule("register","Refresh");d.signal_register(tsip_event_register_type_e.AO_REGISTER,b.get_response_code(),b.get_response_phrase(),b);if(h){d.signal(tsip_event_code_e.DIALOG_CONNECTED,"Connected")}return j}function __tsip_dialog_register_InProgress_2_InProgress_X_401_407_421_494(a){var d=a[0];var b=a[1];var c;if((c=d.update_with_response(b))){d.signal_register(tsip_event_register_type_e.AO_REGISTER,b.get_response_code(),b.get_response_phrase(),b);d.set_last_error(b.get_response_code(),b.get_response_phrase(),b);return c}return d.send_register(false)}function __tsip_dialog_register_InProgress_2_InProgress_X_423(a){var e=a[0];var c=a[1];var b;var d=0;b=c.get_header(tsip_header_type_e.Min_Expires);if(b){e.i_expires=(b.i_value*1000);d=e.send_register(false)}else{tsk_utils_log_error("Missing header: Min_Expires");d=-1}return d}function __tsip_dialog_register_InProgress_2_Terminated_X_300_to_699(a){var c=a[0];var b=a[1];c.set_last_error(b.get_response_code(),b.get_response_phrase(),b);c.signal_register(c.b_unregistering?tsip_event_register_type_e.AO_UNREGISTER:tsip_event_register_type_e.AO_REGISTER,b.get_response_code(),b.get_response_phrase(),b);return 0}function __tsip_dialog_register_InProgress_2_Terminated_X_cancel(a){var d=a[0];var b=a[3];var c;d.set_action_curr(b);c=d.get_layer_transac().cancel_by_dialog(d);d.signal(tsip_event_code_e.DIALOG_CANCELLED,"Registration cancelled");return c}function __tsip_dialog_register_Connected_2_InProgress_X_oRegister(a){var c=a[0];var b=a[3];c.set_action_curr(b);return c.send_register(true)}function __tsip_dialog_register_Any_2_InProgress_X_hangup(a){var c=a[0];var b=a[3];c.set_action_curr(b);c.signal(tsip_event_code_e.DIALOG_TERMINATING,"Disconnecting...");c.b_unregistering=true;return c.send_register(true)}function __tsip_dialog_register_Any_2_InProgress_X_shutdown(a){var b=a[0];b.timer_schedule("register","Shutdown");b.signal(tsip_event_code_e.DIALOG_TERMINATING,"Disconnecting...");b.b_unregistering=true;return b.send_register(true)}function __tsip_dialog_register_Any_2_Terminated_X_transportError(a){var b=a[0];b.signal(tsip_event_code_e.DIALOG_TRANSPORT_ERROR,"Transport error");return 0}function __tsip_dialog_register_Any_2_Terminated_X_Error(a){var c=a[0];var b=a[1];if(b){c.set_last_error(b.get_response_code(),b.get_response_phrase(),b);c.signal_register(c.b_unregistering?tsip_event_register_type_e.AO_UNREGISTER:tsip_event_register_type_e.AO_REGISTER,b.get_response_code(),b.get_response_phrase(),b)}else{c.signal(tsip_event_code_e.DIALOG_GLOBAL_ERROR,"Global error")}return 0}function __tsip_dialog_register_onterm(a){tsk_utils_log_info("=== REGISTER Dialog terminated ===");a.timer_cancel("Refresh");a.timer_cancel("Shutdown");a.signal(tsip_event_code_e.DIALOG_TERMINATED,a.last_error.s_phrase?a.last_error.s_phrase:"Disconnected",a.last_error.o_message);return a.deinit()};