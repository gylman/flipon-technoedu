tsip_dialog_invite.prototype=Object.create(tsip_dialog.prototype);tsip_dialog_invite.prototype.__b_debug_state_machine=true;tsip_dialog_invite.prototype.__i_lo_sdp_request_timeout=50000000;var tsip_dialog_invite_next_offer_type_e={NONE:0,INVITE:1,UPDATE:2,SUCCESS:3};var tsip_dialog_invite_actions_e={ACCEPT:tsip_action_type_e.ACCEPT,REJECT:tsip_action_type_e.HANGUP,DTMF_SEND:tsip_action_type_e.DTMF_SEND,MSRP_SEND_MSG:tsip_action_type_e.LARGE_MESSAGE,O_INVITE:tsip_action_type_e.INVITE,O_CANCEL:tsip_action_type_e.CANCEL,O_HOLD:tsip_action_type_e.HOLD,O_RESUME:tsip_action_type_e.RESUME,O_ECT:tsip_action_type_e.ECT,I_ECT_ACCEPT:tsip_action_type_e.ECT_ACCEPT,I_ECT_REJECT:tsip_action_type_e.ECT_REJECT,I_ECT_LNOTIFY:tsip_action_type_e.ECT_NOTIFY,O_INFO:tsip_action_type_e.INFO,O_BYE:tsip_action_type_e.HANGUP,O_SHUTDOWN:tsip_action_type_e.SHUTDOWN,I_INVITE:10001,O_UPDATE:10002,I_UPDATE:10003,I_CANCEL:10004,I_PRACK:10005,O_PRACK:10006,I_ACK:10007,O_ACK:10008,I_OPTIONS:10009,O_OPTIONS:10010,I_BYE:10011,I_REFER:10012,I_INFO:10013,I_NOTIFY:10014,TIMER_100REL:20001,TIMER_REFRESH:20002,TIMER_RSVP:20003,TIMER_LO_SDP_REQUEST:20004,I_1XX:30001,I_2XX:30002,I_300_to_699:30003,I_401_407:30004,i_422:30005,SHUTDOWN_TIMEDOUT:40001,TRANSPORT_ERROR:40002,ERROR:40003};var tsip_dialog_invite_states_e={STARTED:1,OUTGOING:2,INCOMING:3,TRYING:4,RINGING:5,CANCELLING:6,INPROGRESS:7,HOLDING:20,RESUMING:21,O_ECT_INPROGRESS:40,I_ECT_INPROGRESS:41,I_ECT_REQUESTED:42,CONNECTED:60,TERMINATED:61};function tsip_dialog_invite(b,a){tsip_dialog.call(this);this.o_last_oInvite=null;this.o_wait_oMessage=null;this.o_last_iOffer=null;this.o_last_iRefer=null;this.o_ss_transf=null;this.e_next_offer_type=tsip_dialog_invite_next_offer_type_e.NONE;this.i_rseq=0;this.b_support_update=false;this.supported={};this.supported.b_100rel=b.media.b_100rel;this.supported.b_norefsub=true;this.supported.b_refer_sub=true;this.supported.b_timer=(b.media.timers.i_timeout>0);this.require={};this.require.b_100rel=false;this.require.b_norefsub=false;this.require.b_timer=false;this.hold={};this.hold.b_local=false;this.hold.b_remote=false;this.init(tsip_dialog_type_e.INVITE,a,b,tsip_dialog_invite_states_e.STARTED,tsip_dialog_invite_states_e.TERMINATED);this.set_callback(__tsip_dialog_invite_event_callback);this.o_fsm.set_debug_enabled(tsip_dialog_invite.prototype.__b_debug_state_machine);this.o_fsm.set_onterm_callback(__tsip_dialog_invite_onterm,this);this.o_msession_mgr=null;this.b_is_client=false;this.b_is_transf=false;this.o_timerShutdown=null;this.i_timerShutdown=(tsip_dialog.prototype.__i_timer_shutdown>>1);this.stimers={};this.stimers.i_timeout=b.media.timers.i_timeout;this.stimers.s_refresher=null;this.stimers.i_minse=0;this.stimers.b_is_refresher=false;this.o_timer100Rel=null;this.i_timer100Rel=0;this.o_timerSession=null;this.o_timerShutdown=null;this.i_timerShutdown=tsip_dialog.prototype.__i_timer_shutdown;this.o_timerLoSdpRequest=null;this.i_timerLoSdpRequest=tsip_dialog_invite.prototype.__i_lo_sdp_request_timeout;this.o_fsm.set(tsk_fsm_entry.prototype.CreateAlwaysNothing(tsip_dialog_invite_states_e.STARTED,"tsip_dialog_invite_Started_2_Started_X_any"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.DTMF_SEND,tsip_dialog_invite_states_e.CONNECTED,x0000_Connected_2_Connected_X_oDTMF,"x0000_Connected_2_Connected_X_oDTMF"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.MSRP_SEND_MSG,tsip_dialog_invite_states_e.CONNECTED,x0000_Connected_2_Connected_X_oLMessage,"x0000_Connected_2_Connected_X_oLMessage"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.I_ACK,tsip_dialog_invite_states_e.CONNECTED,x0000_Connected_2_Connected_X_iACK,"x0000_Connected_2_Connected_X_iACK"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.I_INVITE,tsip_dialog_invite_states_e.CONNECTED,x0000_Connected_2_Connected_X_iINVITEorUPDATE,"x0000_Connected_2_Connected_X_iINVITE"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.I_UPDATE,tsip_dialog_invite_states_e.CONNECTED,x0000_Connected_2_Connected_X_iINVITEorUPDATE,"x0000_Connected_2_Connected_X_iUPDATE"),tsk_fsm_entry.prototype.CreateAlways(tsip_dialog_invite_states_e.CONNECTED,tsip_dialog_invite_actions_e.O_INVITE,tsip_dialog_invite_states_e.CONNECTED,x0000_Connected_2_Connected_X_oINVITE,"x0000_Connected_2_Connected_X_oINVITE"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.O_BYE,tsip_dialog_invite_states_e.TRYING,x0000_Any_2_Trying_X_oBYE,"x0000_Any_2_Trying_X_oBYE"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_BYE,tsip_dialog_invite_states_e.TERMINATED,x0000_Any_2_Terminated_X_iBYE,"x0000_Any_2_Terminated_X_iBYE"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_300_to_699,__tsip_dialog_invite_cond_is_resp2bye,tsip_dialog_invite_states_e.TERMINATED,null,"x0000_Any_2_Terminated_X_i3xxTOi6xxBYE"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_2XX,__tsip_dialog_invite_cond_is_resp2bye,tsip_dialog_invite_states_e.TERMINATED,null,"x0000_Any_2_Terminated_X_i2xxBYE"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.O_SHUTDOWN,tsip_dialog_invite_states_e.TRYING,x0000_Any_2_Trying_X_shutdown,"x0000_Any_2_Trying_X_shutdown"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.SHUTDOWN_TIMEDOUT,tsip_dialog_invite_states_e.TERMINATED,null,"tsip_dialog_invite_shutdown_timedout"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_1XX,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_i1xx,"x0000_Any_2_Any_X_i1xx"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.O_INFO,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_oINFO,"x0000_Any_2_Any_X_oINFO"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_INFO,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_iINFO,"x0000_Any_2_Any_X_iINFO"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_PRACK,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_iPRACK,"x0000_Any_2_Any_X_iPRACK"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_OPTIONS,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_iOPTIONS,"x0000_Any_2_Any_X_iOPTIONS"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_2XX,__tsip_dialog_invite_cond_is_resp2invite,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_i2xxINVITEorUPDATE,"x0000_Any_2_Any_X_i2xxINVITE"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_2XX,__tsip_dialog_invite_cond_is_resp2update,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_i2xxINVITEorUPDATE,"x0000_Any_2_Any_X_i2xxUPDATE"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_401_407,__tsip_dialog_invite_cond_is_resp2invite,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_i401_407_INVITEorUPDATE,"x0000_Any_2_Any_X_i401_407_INVITE"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_401_407,__tsip_dialog_invite_cond_is_resp2update,tsk_fsm.prototype.__i_state_any,x0000_Any_2_Any_X_i401_407_INVITEorUPDATE,"x0000_Any_2_Any_X_i401_407_UPDATE"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_2XX,__tsip_dialog_invite_cond_is_resp2prack,tsk_fsm.prototype.__i_state_any,null,"x0000_Any_2_Any_X_i2xxPRACK"),tsk_fsm_entry.prototype.Create(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.I_2XX,__tsip_dialog_invite_cond_is_resp2info,tsk_fsm.prototype.__i_state_any,null,"x0000_Any_2_Any_X_i2xxINFO"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.TIMER_LO_SDP_REQUEST,tsip_dialog_invite_states_e.TERMINATED,x9997_Any_2_Any_X_LoSdpRequestTimeout,"x9997_Any_2_Any_X_LoSdpRequestTimeout"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.TRANSPORT_ERROR,tsip_dialog_invite_states_e.TERMINATED,x9998_Any_2_Terminated_X_transportError,"x9998_Any_2_Terminated_X_transportError"),tsk_fsm_entry.prototype.CreateAlways(tsk_fsm.prototype.__i_state_any,tsip_dialog_invite_actions_e.ERROR,tsip_dialog_invite_states_e.TERMINATED,x9999_Any_2_Terminated_X_Error,"x9999_Any_2_Terminated_X_Error"));this.init_client();this.init_server();this.init_hold();this.init_ect()}tsip_dialog_invite.prototype.signal_invite=function(c,a,d,b){var e=new tsip_event_invite(this.get_session(),a,d,b,c);return e.signal()};tsip_dialog_invite.prototype.send_invite=function(a){return this.send_offer(true,a)};tsip_dialog_invite.prototype.send_update=function(a){return this.send_offer(false,a)};tsip_dialog_invite.prototype.send_offer=function(f,c){var e=-1;var d=null;var g=false;if(!f&&c){tsk_utils_log_warn("ACK is need to ensure the media session")}if((d=this.request_new(f?"INVITE":"UPDATE"))){if(this.o_action_curr){tsip_dialog.prototype.ApplyAction(d,this.o_action_curr)}if((c||f)||((this.o_msession_mgr&&this.o_msession_mgr.b_state_changed)||(this.e_state==tsip_dialog_state_e.INITIAL))){if(!this.o_action_curr||!this.o_action_curr.o_payload){var b=this.o_msession_mgr.get_lo();g=(b==null);if(b){var a=b.toString();d.add_content(new String(a),"application/sdp")}}}if(this.stimers.i_timeout){if(this.require.b_timer){d.add_headers(new tsip_header_Session_Expires(this.stimers.i_timeout,!this.stimers.b_is_refresher),new tsip_header_Require("timer"))}else{if(this.supported.b_timer){d.add_headers(new tsip_header_Session_Expires(this.stimers.i_timeout,!this.stimers.b_is_refresher),new tsip_header_Supported("timer"))}}}if(this.stimers.i_minse){d.add_headers(new tsip_header_Min_SE(this.stimers.i_minse))}if(this.require.b_100rel){d.add_headers(new tsip_header_Require("100rel"))}else{if(this.supported.b_100rel){d.add_headers(new tsip_header_Supported("100rel"))}}if(g){e=0;this.o_wait_oMessage=d;this.timer_schedule("invite","LoSdpRequest")}else{e=this.request_send(d);if(f&&e==0){this.o_last_oInvite=d}}}return e};tsip_dialog_invite.prototype.send_ack=function(d){var e=-1;var c=null;var f=false;if((c=this.request_new("ACK"))){if(this.b_is_client&&(this.o_last_oInvite&&!this.o_last_oInvite.has_content())){var b=this.o_msession_mgr.get_lo();f=(b==null);if(b){var a=b.toString();c.add_content(new String(a),"application/sdp")}if(!this.o_msession_mgr.is_started()&&(this.o_msession_mgr.has_lo()&&this.o_msession_mgr.has_ro())){e=this.o_msession_mgr.start()}}c.o_hdr_CSeq.i_seq=d.o_hdr_CSeq.i_seq;if(f){this.o_wait_oMessage=c;this.timer_schedule("invite","LoSdpRequest");return 0}else{return this.request_send(c)}}return e};tsip_dialog_invite.prototype.send_prack=function(g){if(!g||!g.o_hdr_CSeq){tsk_utils_log_error("Invalid parameter");return -1}var e=-1;var c=null;var d;var f=false;if((d=g.get_header(tsip_header_type_e.RSeq))){if(self.i_rseq&&(d.i_value<=this.i_rseq)){tsk_utils_log_warn("1xx.RSeq value is not one higher than lastINVITE.RSeq");return 0}this.i_rseq=d.i_value}if(!(c=this.request_new("PRACK"))){tsk_utils_log_error("Failed to create PRACK request");return -2}c.add_header(new tsip_header_RAck(this.i_rseq,g.o_hdr_CSeq.i_seq,g.o_hdr_CSeq.s_method));if(this.b_is_client&&(this.o_last_oInvite&&!this.o_last_oInvite.has_content())){var b=this.o_msession_mgr.get_lo();f=(b==null);if(b){var a=b.toString();c.add_content(new String(a),"application/sdp")}}if(f){this.o_wait_oMessage=c;this.timer_schedule("invite","LoSdpRequest");return 0}else{return this.request_send(c)}};tsip_dialog_invite.prototype.send_response=function(f,b,e,i){var a;var h=-1;var d=false;if((a=this.response_new(b,e,f))){if(f.is_invite()||f.is_update()){if(this.require.b_timer){a.add_headers(new tsip_header_Require("timer"),new tsip_header_Session_Expires(this.stimers.i_timeout,tsk_string_iequals(this.stimers.s_refresher,"uas")))}else{if(this.supported.b_timer){a.add_headers(new tsip_header_Supported("timer"),new tsip_header_Session_Expires(this.stimers.i_timeout,tsk_string_iequals(this.stimers.s_refresher,"uas")))}}if(this.stimers.i_minse){a.add_headers(new tsip_header_Min_SE(this.stimers.i_minse))}if(b==422){a.add_headers(new tsip_header_Dummy("Reason",'SIP; cause=422; text="Session Interval Too Small"'))}if(b==180||b==183){if(this.require.b_100rel){if(this.i_rseq==0){this.i_rseq=Math.abs((rand()^rand())+1)}a.add_headers(new tsip_header_Require("100rel"),new tsip_header_RSeq(this.i_rseq));this.o_last_o1xxrel=a;this.timer_cancel("100Rel");this.i_timer100Rel=this.get_stack().o_timers.getA();this.timer_schedule("invite","100Rel")}}if(this.o_msession_mgr&&i){var c=this.o_msession_mgr.get_lo();d=(c==null);if(c){var g=c.toString();a.add_content(new String(g),"application/sdp")}}a.add_headers(new tsip_header_Dummy("Allow",TSIP_HEADER_ALLOW_DEFAULT))}else{if(f.is_refer()){if(this.require.b_norefersub){a.add_headers(new tsip_header_Require("norefersub"))}if(this.supported.b_norefersub){a.add_headers(new tsip_header_Supported("norefersub"))}}}if(d){this.o_wait_oMessage=a;this.timer_schedule("invite","LoSdpRequest");return 0}else{return this.response_send(a)}}return h};tsip_dialog_invite.prototype.send_error=function(c,a,e,b){var d;if((d=this.response_new(a,e,c))){d.add_headers(new tsip_header_Dummy("Reason",b));return this.response_send(d)}else{tsk_utils_log_error("Failed to create new message");return -1}};tsip_dialog_invite.prototype.send_bye=function(){var a=-1;var b;if((b=this.request_new("BYE"))){a=this.request_send(b)}return a};tsip_dialog_invite.prototype.send_info=function(a,b){var d=-1;var c;if((c=this.request_new("INFO"))){if(a&&b){c.add_content(new String(a),b)}d=this.request_send(c)}return d};tsip_dialog_invite.prototype.send_cancel=function(){if(this.o_last_oInvite){var a;var c;if((a=new tsip_request("CANCEL",this.o_last_oInvite.line.request.o_uri,null,null,this.o_last_oInvite.o_hdr_Call_ID.s_value,this.o_last_oInvite.o_hdr_CSeq.i_seq))){a.o_hdr_firstVia=this.o_last_oInvite.o_hdr_firstVia;a.o_hdr_From=this.o_last_oInvite.o_hdr_From;a.o_hdr_To=this.o_last_oInvite.o_hdr_To;for(c=0;c<this.o_last_oInvite.ao_headers.length;++c){switch(this.o_last_oInvite.ao_headers[c].e_type){case tsip_header_type_e.Route:case tsip_header_type_e.Proxy_Authorization:case tsip_header_type_e.Authorization:a.ao_headers.push(this.o_last_oInvite.ao_headers[c]);break}}if(this.get_stack().network.e_proxy_cscf_type==tsip_transport_type_e.WS||this.get_stack().network.e_proxy_cscf_type==tsip_transport_type_e.WSS){var b=this.get_stack().__get_proxy_outbound_uri_string();if(b){a.add_header(new tsip_header_Dummy("Route",b),true)}}return this.request_send(a)}else{tsk_utils_log_error("Failed to create CANCEL request");return -2}}else{tsk_utils_log_warn("There is no INVITE request to cancel");return 0}};tsip_dialog_invite.prototype.notify_parent=function(c){var b=this.get_layer_dialog().find_by_ssid(this.get_session().i_id_parent);if(b){var a=new tsip_action(tsip_action_type_e.ECT_NOTIFY);if(a){return b.fsm_act(a.e_type,c,a)}}else{tsk_utils_log_error("Failed to find parent with id="+this.get_session().i_id_parent+"")}return -1};tsip_dialog_invite.prototype.new_msession_mgr=function(c,d,b,e){var a=new tmedia_session_mgr(c,d,b,e,__tsip_dialog_invite_media_callback,this);a.set(tmedia_session_mgr.prototype.SetParamSession(a.e_type,"ice-servers",this.get_stack().network.ao_ice_servers),tmedia_session_mgr.prototype.SetParamSession(a.e_type,"cache-stream",this.get_stack().network.b_cache_stream),tmedia_session_mgr.prototype.SetParamSession(a.e_type,"bandwidth",this.get_session().media.o_bandwidth),tmedia_session_mgr.prototype.SetParamSession(a.e_type,"video-size",this.get_session().media.o_video_size));return a};tsip_dialog_invite.prototype.process_ro=function(d,c){var b=null;var g;var f;var a;var e=0;if(!d){tsk_utils_log_error("Invalid parameter");return -1}if(d.has_content()){if(tsk_string_iequals("application/sdp",d.get_content_type())){if(!(b=tsdp_message.prototype.Parse(d.get_content_as_string()))){tsk_utils_log_error("Failed to parse remote sdp message");return -2}}else{tsk_utils_log_error("["+d.get_content_type()+"] content-type is not supportted");return -3}}else{if(this.e_state==tsip_dialog_state_e.INITIAL&&d.is_invite()){this.get_session().media.e_type=tmedia_defaults_get_media_type()}else{return 0}}a=(this.o_msession_mgr==null);g=this.get_session().media.e_type;f=b?b.get_media_type():g;if(!this.o_msession_mgr){this.get_session().media.e_type=f;this.o_msession_mgr=this.new_msession_mgr(f,this.get_stack().network.s_local_ip,false,(b==null))}if(b){if((e=this.o_msession_mgr.set_ro(b,c))){tsk_utils_log_error("Failed to set remote offer");return e}}if(!a&&(g!=f)&&(this.o_msession_mgr.sdp.o_lo&&this.o_msession_mgr.sdp.o_ro)){this.get_session().media.e_type=f;this.signal_invite(tsip_event_invite_type_e.M_UPDATED,d.get_response_code(),d.get_response_phrase(),d)}if(!this.o_msession_mgr.is_started()&&(this.o_msession_mgr.has_lo()&&this.o_msession_mgr.has_ro())){e=this.o_msession_mgr.start();if(e==0&&this.e_state==tsip_dialog_state_e.EARLY){this.signal_invite(tsip_event_invite_type_e.M_EARLY_MEDIA,d.get_response_code(),d.get_response_phrase(),d)}}return e};function __tsip_dialog_invite_timer_callback(b,a){var c=-1;if(b){if(b.o_timerSession==a){c=b.fsm_act(tsip_dialog_invite_actions_e.TIMER_REFRESH,null,null)}else{if(b.o_timer100Rel==a){c=b.fsm_act(tsip_dialog_invite_actions_e.TIMER_100REL,null,null)}else{if(b.o_timerShutdown==a){c=b.fsm_act(tsip_dialog_invite_actions_e.SHUTDOWN_TIMEDOUT,null,null)}else{if(b.o_timerLoSdpRequest==a){c=b.fsm_act(tsip_dialog_invite_actions_e.TIMER_LO_SDP_REQUEST,null,null)}}}}}return c}function __tsip_dialog_invite_media_callback(a,f,e){var g;switch(f){case tmedia_session_events_e.GET_LO_SUCCESS:a.timer_cancel("LoSdpRequest");if(a.o_wait_oMessage){var d=a.o_msession_mgr.get_lo();var c=null;if(d&&(c=d.toString())){a.o_wait_oMessage.add_content(new String(c),"application/sdp");if(a.o_wait_oMessage.is_request()){if(a.o_wait_oMessage.is_ack()){g=a.get_stack().o_layer_transport.send(null,a.o_wait_oMessage)}else{g=a.request_send(a.o_wait_oMessage);if(g==0&&a.o_wait_oMessage.is_invite()){a.o_last_oInvite=a.o_wait_oMessage}}}else{g=a.response_send(a.o_wait_oMessage)}}a.o_wait_oMessage=null}else{if(a.e_state==tsip_dialog_state_e.ESTABLISHED){if(a.e_next_offer_type==tsip_dialog_invite_next_offer_type_e.SUCCESS&&a.o_last_iOffer){g=a.send_response(a.o_last_iOffer,200,"OK",true)}else{g=a.send_offer(true,true)}}}if(a.o_msession_mgr&&!a.o_msession_mgr.is_started()&&(a.o_msession_mgr.has_lo()&&a.o_msession_mgr.has_ro())){g=a.o_msession_mgr.start()}a.e_next_offer_type=tsip_dialog_invite_next_offer_type_e.NONE;break;case tmedia_session_events_e.GET_LO_FAILED:a.timer_cancel("LoSdpRequest");a.set_last_error(tsip_event_code_e.DIALOG_WEBRTC_ERROR,"Failed to get local SDP offer");a.e_next_offer_type=tsip_dialog_invite_next_offer_type_e.NONE;var b=new tsip_action(tsip_action_type_e.HANGUP);b.set_line_resp(603,"Failed to get local SDP");a.hangup(b);break;case tmedia_session_events_e.STREAM_LOCAL_REQUESTED:a.signal_invite(tsip_event_invite_type_e.M_STREAM_LOCAL_REQUESTED,tsip_event_code_e.DIALOG_MEDIA_LOCAL_REQUESTED,"Media Requested",null);break;case tmedia_session_events_e.STREAM_LOCAL_ACCEPTED:a.signal_invite(tsip_event_invite_type_e.M_STREAM_LOCAL_ACCEPTED,tsip_event_code_e.DIALOG_MEDIA_LOCAL_ACCEPTED,"Media Accepted",null);break;case tmedia_session_events_e.STREAM_LOCAL_REFUSED:a.signal_invite(tsip_event_invite_type_e.M_STREAM_LOCAL_REFUSED,tsip_event_code_e.DIALOG_MEDIA_LOCAL_REFUSED,"Media Refused",null);var b=new tsip_action(tsip_action_type_e.HANGUP);b.set_line_resp(603,"Media stream permission denied");a.hangup(b);break;case tmedia_session_events_e.STREAM_LOCAL_ADDED:a.get_session().__set_stream_local(a.o_msession_mgr.get_stream_local());a.signal_invite(tsip_event_invite_type_e.M_STREAM_LOCAL_ADDED,tsip_event_code_e.DIALOG_MEDIA_ADDED,"Media Added",null);break;case tmedia_session_events_e.STREAM_LOCAL_REMOVED:a.get_session().__set_stream_local(null);a.signal_invite(tsip_event_invite_type_e.M_STREAM_LOCAL_REMOVED,tsip_event_code_e.DIALOG_MEDIA_REMOVED,"Media Removed",null);break;case tmedia_session_events_e.STREAM_REMOTE_ADDED:a.get_session().__set_stream_remote(a.o_msession_mgr.get_stream_remote());a.signal_invite(tsip_event_invite_type_e.M_STREAM_REMOTE_ADDED,tsip_event_code_e.DIALOG_MEDIA_ADDED,"Media Added",null);break;case tmedia_session_events_e.STREAM_REMOTE_REMOVED:a.get_session().__set_stream_remote(null);a.signal_invite(tsip_event_invite_type_e.M_STREAM_REMOTE_REMOVED,tsip_event_code_e.DIALOG_MEDIA_REMOVED,"Media Removed",null);break;case tmedia_session_events_e.RFC5168_REQUEST_IDR:a.send_info('<?xml version="1.0" encoding="utf-8"?>\r\n <media_control>\r\n   <vc_primitive>\r\n     <to_encoder>\r\n       <picture_fast_update>\r\n       </picture_fast_update>\r\n     </to_encoder>\r\n   </vc_primitive>\r\n </media_control>\r\n',"application/media_control+xml");break}}function __tsip_dialog_invite_event_callback(a,b,c){var d=-1;switch(b){case tsip_dialog_event_type_e.I_MSG:if(c){if(c.is_response()){if(c.is_1xx()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_1XX,c,null)}else{if(c.is_2xx()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_2XX,c,null)}else{if(c.is_response_xxx(401)||c.is_response_xxx(407)){d=a.fsm_act(tsip_dialog_invite_actions_e.I_401_407,c,null)}else{if(c.is_response_xxx(422)){d=a.fsm_act(tsip_dialog_invite_actions_e.I_422,c,null)}else{if(c.is_3456()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_300_to_699,c,null)}}}}}}else{if(c.is_invite()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_INVITE,c,null)}else{if(c.is_update()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_UPDATE,c,null)}else{if(c.is_prack()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_PRACK,c,null)}else{if(c.is_ack()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_ACK,c,null)}else{if(c.is_options()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_OPTIONS,c,null)}else{if(c.is_bye()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_BYE,c,null)}else{if(c.is_cancel()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_CANCEL,c,null)}else{if(c.is_info()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_INFO,c,null)}else{if(c.is_notify()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_NOTIFY,c,null)}else{if(c.is_refer()){d=a.fsm_act(tsip_dialog_invite_actions_e.I_REFER,c,null)}}}}}}}}}}}}break;case tsip_dialog_event_type_e.CANCELED:d=a.fsm_act(tsip_dialog_invite_actions_e.O_CANCEL,c,null);break;case tsip_dialog_event_type_e.TIMEDOUT:if(!c||(!c.is_request()||!c.is_info())){d=a.fsm_act(tsip_dialog_invite_actions_e.TRANSPORT_ERROR,c,null)}break;case tsip_dialog_event_type_e.TERMINATED:case tsip_dialog_event_type_e.ERROR:case tsip_dialog_event_type_e.TRANSPORT_ERROR:d=a.fsm_act(tsip_dialog_invite_actions_e.TRANSPORT_ERROR,c,null);break}return d}function __tsip_dialog_invite_cond_is_resp2invite(b,a){return a.is_response_to_invite()}function __tsip_dialog_invite_cond_is_resp2update(b,a){return a.is_response_to_update()}function __tsip_dialog_invite_cond_is_resp2invite_or_update(b,a){return __tsip_dialog_invite_cond_is_resp2invite(b,a)||__tsip_dialog_invite_cond_is_resp2update(b,a)}function __tsip_dialog_invite_cond_is_resp2bye(b,a){return a.is_response_to_bye()}function __tsip_dialog_invite_cond_is_resp2prack(b,a){return a.is_response_to_prack()}function __tsip_dialog_invite_cond_is_resp2info(b,a){return a.is_response_to_info()}function __tsip_dialog_invite_cond_is_resp2cancel(b,a){return a.is_response_to_cancel()}function __tsip_dialog_invite_cond_is_resp2refer(b,a){return a.is_response_to_refer()}function __tsip_dialog_invite_cond_is_1xx_notify(c,b){var a=__tsip_dialog_invite_get_sip_frag_respcode(b);return(a>=100&&a<=199)}function __tsip_dialog_invite_cond_is_23456_notify(c,b){var a=__tsip_dialog_invite_get_sip_frag_respcode(b);return(a>=200&&a<=699)}function __tsip_dialog_invite_cond_is_f_refer(c,a){var b=a.get_header(tsip_header_type_e.Refer_To);return(!b||!b.o_uri)}function __tsip_dialog_invite_cond_is_1xx_f_notify(b,a){return a.is_1xx()}function __tsip_dialog_invite_cond_is_23456_f_notify(b,a){return a.is_23456()}function x0000_Connected_2_Connected_X_oDTMF(a){tsk_utils_log_error("Not implemented");return 0}function x0000_Connected_2_Connected_X_oLMessage(a){tsk_utils_log_error("Not implemented");return 0}function x0000_Connected_2_Connected_X_iACK(a){var e=a[0];var c=a[1];var d=0;var b=e.o_msession_mgr&&!e.o_msession_mgr.has_ro();if((d=e.process_ro(c,b))){return d}if(e.o_msession_mgr){d=e.o_msession_mgr.acked()}e.signal_invite(tsip_event_invite_type_e.DIALOG_REQUEST_INCOMING,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",c);return d}function x0000_Connected_2_Connected_X_iINVITEorUPDATE(a){var d=a[0];var e=a[1];var h;var f;var b=d.o_msession_mgr?d.o_msession_mgr.get_media_type():tmedia_type_e.NONE;var c=d.o_msession_mgr?d.o_msession_mgr.is_roap():false;var i;var g;d.o_last_iOffer=e;if(c){d.e_next_offer_type=tsip_dialog_invite_next_offer_type_e.SUCCESS}if((h=d.process_ro(e,true))){return h}g=e.has_content();i=d.o_msession_mgr?d.o_msession_mgr.get_media_type():tmedia_type_e.NONE;f=!e.has_content()&&e.is_invite();h=d.hold_handle(e);if(!c){h=d.send_response(e,200,"OK",(d.o_msession_mgr&&(g||f||d.o_msession_mgr.has_ro_changed()||d.o_msession_mgr.has_state_changed()||(b!=i))))}d.signal_invite(tsip_event_invite_type_e.DIALOG_REQUEST_INCOMING,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",e);return h}function x0000_Connected_2_Connected_X_oINVITE(a){tsk_utils_log_error("Not implemented");return 0}function x0000_Any_2_Any_X_i1xx(a){var e=a[0];var d=a[1];var c=0;if((c=e.update_with_response(d))){return c}if((d.get_response_code()>=101&&d.get_response_code()<=199)){var b=e.o_msession_mgr&&!e.o_msession_mgr.has_lo();if(d.has_content()&&(c=e.process_ro(d,b))){return c}if(d.is_required("100rel")&&(c=e.send_prack(d))){return c}}c=e.signal_invite(tsip_event_invite_type_e.I_AO_REQUEST,d.get_response_code(),d.get_response_phrase(),d);if(e.b_is_transf){c=e.notify_parent(d)}return c}function x0000_Any_2_Any_X_oINFO(a){var e=a[0];var b=a[2];var c;e.b_running=true;e.set_action_curr(b);if((c=e.request_new("INFO"))){var d;if((d=tsip_dialog.prototype.ApplyAction(c,b))==0){d=e.request_send(c)}return d}else{tsk_utils_log_error("Failed to create new INFO request");return -1}}function x0000_Any_2_Any_X_iINFO(a){var e=a[0];var b=a[1];var c=e.send_response(b,200,"OK");e.signal_invite(tsip_event_invite_type_e.DIALOG_REQUEST_INCOMING,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",b);if(e.o_msession_mgr&&b.has_content()){var d=b.get_content_as_string();if(!tsk_string_is_null_or_empty(d)){e.o_msession_mgr.processContent("INFO",b.get_content_type(),d,d.length)}}return c}function x0000_Any_2_Any_X_i401_407_INVITEorUPDATE(a){var d=a[0];var b=a[1];var c=0;if((c=d.update_with_response(b))){d.signal_invite(tsip_event_invite_type_e.I_AO_REQUEST,b.get_response_code(),b.get_response_phrase(),b);return c}return d.send_offer(b.is_response_to_invite(),false)}function x0000_Any_2_Any_X_i2xxINVITEorUPDATE(a){var e=a[0];var c=a[1];var d=0;if(this.o_last_oInvite&&this.o_last_oInvite.o_hdr_CSeq.i_seq==c.o_hdr_CSeq.i_seq){if(c.is_response_to_invite()){return e.send_ack(c)}}if((d=e.update_with_response(c))){return d}var b=e.o_msession_mgr&&!e.o_msession_mgr.has_lo();if((d=e.process_ro(c,b))){return d}if(c.is_response_to_invite()){d=e.send_ack(c)}return d}function x0000_Any_2_Any_X_iPRACK(a){tsk_utils_log_error("Not implemented");return 0}function x0000_Any_2_Any_X_iOPTIONS(a){var c=a[0];var b=a[1];c.signal_invite(tsip_event_invite_type_e.DIALOG_REQUEST_INCOMING,tsip_event_code_e.DIALOG_REQUEST_INCOMING,"Incoming Request",b);return c.send_response(b,200,"OK",false)}function x0000_Any_2_Trying_X_oBYE(a){var c=a[0];var b;c.signal(tsip_event_code_e.DIALOG_TERMINATING,"Call terminating...");if((b=c.send_bye())==0){if(c.o_msession_mgr&&c.o_msession_mgr.is_started()){b=c.o_msession_mgr.stop()}}return b}function x0000_Any_2_Terminated_X_iBYE(a){var c=a[0];var b=a[1];c.set_last_error(tsip_event_code_e.DIALOG_TERMINATED,"Call terminated");return c.send_response(b,200,"OK",false)}function x0000_Any_2_Trying_X_shutdown(a){var b=a[0];b.timer_schedule("invite","Shutdown");b.signal(tsip_event_code_e.DIALOG_TERMINATING,"Call terminating...");if(b.e_state==tsip_dialog_state_e.ESTABLISHED){return b.send_bye()}else{if(b.e_state==tsip_dialog_state_e.EARLY){return b.send_cancel()}}}function x9997_Any_2_Any_X_LoSdpRequestTimeout(a){tsk_utils_log_error("Not implemented");return 0}function x9998_Any_2_Terminated_X_transportError(a){var b=a[0];b.set_last_error(tsip_event_code_e.DIALOG_TRANSPORT_ERROR,"Transport error");return 0}function x9999_Any_2_Terminated_X_Error(a){var b=a[0];return 0}function __tsip_dialog_invite_onterm(a){tsk_utils_log_info("=== INVITE Dialog terminated ===");a.timer_cancel("100Rel");a.timer_cancel("Session");a.timer_cancel("Shutdown");a.timer_cancel("LoSdpRequest");if(a.o_msession_mgr){i_ret=a.o_msession_mgr.stop()}a.signal(tsip_event_code_e.DIALOG_TERMINATED,a.last_error.s_phrase?a.last_error.s_phrase:"Call terminated",a.last_error.o_message);return a.deinit()}if(!window.__b_release_mode){tsip_api_add_js_scripts("head","src/tinySIP/src/dialogs/tsip_dialog_invite__client.js","src/tinySIP/src/dialogs/tsip_dialog_invite__ect.js","src/tinySIP/src/dialogs/tsip_dialog_invite__hold.js","src/tinySIP/src/dialogs/tsip_dialog_invite__server.js","src/tinySIP/src/dialogs/tsip_dialog_invite__timers.js")};