var __o_session_roap=null;var tmedia_session_state_e={NONE:-1,OFFER_SENT:0,OFFER_RECEIVED:1,ANSWER_SENT:2,ANSWER_RECEIVED:3,LOCAL_HOLD:10};function tmedia_session_roap(a){this.__proto__.__proto__=new tmedia_session(tmedia_type_e.AUDIO_VIDEO,a);this.e_state=tmedia_session_state_e.NONE;this.o_pc=null;this.o_pc_json=null;this.o_remote_stream=null;this.o_local_stream=null;this.o_sdp_json_lo=null;this.o_sdp_lo=null;this.o_sdp_json_ro=null;this.o_sdp_ro=null;this.b_ro_changed=false;this.b_lo_held=false;this.b_ro_held=false}tmedia_session_roap.prototype.__set=function(a){return 0};tmedia_session_roap.prototype.__prepare=function(){return 0};tmedia_session_roap.prototype.__start=function(){return 0};tmedia_session_roap.prototype.__pause=function(){return 0};tmedia_session_roap.prototype.__stop=function(){tsk_utils_log_info("PeerConnection::stop()");if(this.o_pc){this.o_pc.close();this.o_pc=null}this.o_mgr.set_stream_remote(null);this.o_mgr.set_stream_local(null);return 0};tmedia_session_roap.prototype.__get_lo=function(){tsk_utils_log_info("ROAP: __get_lo");if(!this.o_pc){__o_session_roap=this;this.o_mgr.set_stream_local(__o_roap_stream);__o_session_roap.o_local_stream=__o_roap_stream;__o_session_roap.o_pc=new __o_peerconnection_class("STUN stun.l.google.com:19302",__o_session_roap.__on_signaling_message);__o_session_roap.o_pc.o_session=__o_session_roap;__o_session_roap.o_pc.onstatechange=tmedia_session_roap.prototype.__on_state_change;__o_session_roap.o_pc.onconnecting=tmedia_session_roap.prototype.__on_connecting;__o_session_roap.o_pc.onopen=tmedia_session_roap.prototype.__on_open;__o_session_roap.o_pc.onaddstream=tmedia_session_roap.prototype.__on_add_stream;__o_session_roap.o_pc.onremovestream=tmedia_session_roap.prototype.__on_remove_stream;if(__o_session_roap.o_pc){tsk_utils_log_info("ROAP: __get_lo::addStream()");__o_session_roap.o_pc.addStream(__o_session_roap.o_local_stream)}if(this.e_state==tmedia_session_state_e.OFFER_RECEIVED&&this.o_sdp_ro){this.__set_ro(this.o_sdp_ro,true)}return null}return this.o_sdp_lo};tmedia_session_roap.prototype.__hold=function(){this.b_lo_held=true;if(this.o_pc&&this.o_local_stream){this.o_pc.removeStream(this.o_local_stream);return 0}tsk_utils_log_error("Invalid state");return -1};tmedia_session_roap.prototype.__set_ro=function(g,j){tsk_utils_log_info("ROAP: __set_ro");this.o_sdp_ro=g;if(!this.o_pc){this.e_state=tmedia_session_state_e.OFFER_RECEIVED;return 0}var h=null;var c;var a=1;var f=Math.floor((Math.random()*65535));var i;var d;if((c=this.o_sdp_ro.get_header(tsdp_header_type_e.O))){a=c.i_sess_version}this.e_state=j?tmedia_session_state_e.OFFER_RECEIVED:tmedia_session_state_e.ANSWER_RECEIVED;if(this.o_pc_json){i=this.o_pc_json.answererSessionId?this.o_pc_json.answererSessionId:tsk_string_random(16);d=this.o_pc_json.offererSessionId?this.o_pc_json.offererSessionId:tsk_string_random(16);if(this.o_pc_json.messageType=="OFFER"){h=tsk_string_format('{\n"answererSessionId" : "{0}",\n"messageType" : "ANSWER",\n"offererSessionId" : "{1}",\n"sdp" : "{2}",\n"seq" : {3}\n}\n',i,d,this.o_sdp_ro.toString("\\r\\n"),this.o_sdp_json_lo.seq)}else{h=tsk_string_format('{\n"answererSessionId" : "{0}",\n"messageType" : "OFFER",\n"offererSessionId" : "{1}",\n"sdp" : "{2}",\n"seq" : {3},\n"tieBreaker": {4}\n}\n',i,d,this.o_sdp_ro.toString("\\r\\n"),(this.o_sdp_json_lo.seq+1),f)}}else{h=tsk_string_format('{\n"messageType" : "OFFER",\n"offererSessionId" : "{0}",\n"sdp" : "{1}",\n"seq" : {2},\n"tieBreaker": {3}\n}\n',tsk_string_random(16),this.o_sdp_ro.toString("\\r\\n"),a,f)}try{tsk_utils_log_info("RO="+h);this.o_sdp_json_ro=JSON.parse(h);this.o_pc.processSignalingMessage("SDP\n"+h);return 0}catch(b){__o_session_roap.o_mgr.callback(tmedia_session_events_e.SET_RO_FAILED,this.e_type);tsk_utils_log_error(b);return -2}};tmedia_session_roap.prototype.__acked=function(){if(this.o_sdp_json_lo){if(this.o_sdp_json_lo.messageType=="ANSWER"){var a=tsk_string_format('SDP\n{\n"answererSessionId" : "{0}",\n"messageType" : "OK",\n"offererSessionId" : "{1}",\n"seq" : {2}\n}\n',this.o_sdp_json_lo.offererSessionId,this.o_sdp_json_lo.answererSessionId,this.o_sdp_json_lo.seq);tsk_utils_log_info("ACK="+a);try{this.o_pc.processSignalingMessage(a)}catch(b){tsk_utils_log_error(b);return -2}}}return 0};tmedia_session_roap.prototype.__on_signaling_message=function(j){tsk_utils_log_info("LO="+j);if(tsk_string_index_of(j,3,"SDP")==0){j=j.substring(3)}try{__o_session_roap.o_pc_json=JSON.parse(j);if(__o_session_roap.o_pc_json.messageType=="OFFER"||__o_session_roap.o_pc_json.messageType=="ANSWER"){var i=tsdp_message.prototype.Parse(__o_session_roap.o_pc_json.sdp);if(!i){tsk_utils_log_error("failed to parse sdp"+__o_session_roap.o_pc_json.sdp);__o_session_roap.o_mgr.callback(tmedia_session_events_e.GET_LO_FAILED,this.e_type);return}var b=i.get_header_m_by_name("audio");var f=i.get_header_m_by_name("video");__o_session_roap.o_sdp_json_lo=__o_session_roap.o_pc_json;__o_session_roap.o_sdp_lo=i;var a;if((a=__o_session_roap.o_sdp_lo.get_header(tsdp_header_type_e.S))){a.s_value="webrtc (roap)"}var g;if((g=__o_session_roap.o_sdp_lo.get_header(tsdp_header_type_e.O))){g.i_sess_version=__o_session_roap.o_sdp_json_lo.seq}if(__o_session_roap.b_lo_held||__o_session_roap.b_ro_held){var h;var d=0;while((h=__o_session_roap.o_sdp_lo.get_header_at(tsdp_header_type_e.M,d++))){h.set_holdresume_att(__o_session_roap.b_lo_held,__o_session_roap.b_ro_held)}}if(__o_session_roap.e_state==tmedia_session_state_e.LOCAL_HOLD){__o_session_roap.e_state=tmedia_session_state_e.OFFER_SENT}__o_session_roap.o_mgr.callback(tmedia_session_events_e.GET_LO_SUCCESS,this.e_type)}else{if(__o_session_roap.o_pc_json.messageType=="OK"){__o_session_roap.o_mgr.callback(tmedia_session_events_e.SET_RO_SUCCESS,this.e_type)}}if(__o_session_roap.o_pc_json.messageType=="ERROR"){tsk_utils_log_error("onSignalingMessage::messageType = ERROR");__o_session_roap.o_mgr.callback(tmedia_session_events_e.GET_LO_FAILED,this.e_type)}}catch(c){__o_session_roap.o_mgr.callback(tmedia_session_events_e.GET_LO_FAILED,this.e_type);tsk_utils_log_error(c);return}};tmedia_session_roap.prototype.__on_state_change=function(a){tsk_utils_log_info("__on_state_change")};tmedia_session_roap.prototype.__on_connecting=function(a){tsk_utils_log_info("__on_connecting")};tmedia_session_roap.prototype.__on_open=function(a){tsk_utils_log_info("__on_open")};tmedia_session_roap.prototype.__on_add_stream=function(a){tsk_utils_log_info("__on_add_stream");if(__o_session_roap){__o_session_roap.o_remote_stream=a.stream;if(__o_session_roap.o_mgr){__o_session_roap.o_mgr.set_stream_remote(a.stream)}}};tmedia_session_roap.prototype.__on_remove_stream=function(a){tsk_utils_log_info("__on_remove_stream");if(__o_session_roap){__o_session_roap.o_remote_stream=null;if(__o_session_roap.o_mgr){__o_session_roap.o_mgr.set_stream_remote(null)}}};