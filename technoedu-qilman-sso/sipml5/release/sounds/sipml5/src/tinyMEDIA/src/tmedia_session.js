var __o_peerconnection_class=undefined;var __o_sessiondescription_class=undefined;var __o_iceCandidate_class=undefined;var tmedia_session_events_e={GET_LO_SUCCESS:0,GET_LO_FAILED:1,SET_RO_SUCCESS:10,SET_RO_FAILED:11,SET_ACK_SUCCESS:20,SET_ACK_FAILED:21,STREAM_LOCAL_REQUESTED:30,STREAM_LOCAL_ACCEPTED:31,STREAM_LOCAL_REFUSED:32,STREAM_LOCAL_ADDED:33,STREAM_LOCAL_REMOVED:34,STREAM_REMOTE_ADDED:35,STREAM_REMOTE_REMOVED:36,RFC5168_REQUEST_IDR:40};tmedia_session_mgr.prototype.__ao_supported_media=[tmedia_type_e.AUDIO,tmedia_type_e.VIDEO];function tmedia_session_mgr(d,e,c,f,b,a){this.s_addr=e;this.s_public_addr=null;this.b_ipv6=c;this.fn_callback=b;this.o_usr_data=a;this.sdp={};this.sdp.i_lo_ver=-1;this.sdp.o_lo=null;this.sdp.i_ro_ver=-1;this.sdp.o_ro=null;this.o_stream_local=null;this.o_stream_remote=null;this.b_started=false;this.b_ro_changed=false;this.b_lo_changed=false;this.b_state_changed=false;this.b_media_type_changed=false;this.e_type=d;this.ao_sessions=new Array();this.ao_params=new Array();if(__o_peerconnection_class==undefined){if(tsk_utils_have_webrtc4all()){__o_peerconnection_class=w4aPeerConnection;__o_sessiondescription_class=w4aSessionDescription;__o_iceCandidate_class=w4aIceCandidate}else{if(tsk_utils_have_webrtc()){if(WebRtc4all_GetType()==WebRtcType_e.NATIVE){if(window.webkitPeerConnection00&&window.SessionDescription&&window.IceCandidate){__o_peerconnection_class=window.webkitPeerConnection00;__o_sessiondescription_class=window.SessionDescription;__o_iceCandidate_class=window.IceCandidate}else{if(window.nativeRTCPeerConnection&&window.nativeRTCSessionDescription&&window.nativeRTCIceCandidate){__o_peerconnection_class=window.nativeRTCPeerConnection;__o_sessiondescription_class=window.nativeRTCSessionDescription;__o_iceCandidate_class=window.nativeRTCIceCandidate}}}else{if(WebRtc4all_GetType()==WebRtcType_e.ERICSSON){if(window.webkitPeerConnection){__o_peerconnection_class=window.webkitPeerConnection}}}}}tsk_utils_log_info("PeerConnectionClass = "+(__o_peerconnection_class||"unknown")+" SessionDescriptionClass = "+(__o_sessiondescription_class||"unknown")+" IceCandidateClass = "+(__o_iceCandidate_class||"unknown"))}if(f){this.load_sessions()}}tmedia_session_mgr.prototype.is_roap=function(){return(WebRtc4all_GetType()==WebRtcType_e.ERICSSON)};tmedia_session_mgr.prototype.is_jsep=function(){return !this.is_roap()};tmedia_session_mgr.prototype.get_stream_local=function(){return this.o_stream_local};tmedia_session_mgr.prototype.get_stream_remote=function(){return this.o_stream_remote};tmedia_session_mgr.prototype.set_stream_local=function(a){this.o_stream_local=a;this.callback(a?tmedia_session_events_e.STREAM_LOCAL_ADDED:tmedia_session_events_e.STREAM_LOCAL_REMOVED,tmedia_type_e.VIDEO)};tmedia_session_mgr.prototype.set_stream_remote=function(a){this.o_stream_remote=a;this.callback(a?tmedia_session_events_e.STREAM_REMOTE_ADDED:tmedia_session_events_e.STREAM_REMOTE_REMOVED,tmedia_type_e.VIDEO)};tmedia_session_mgr.prototype.set_fn_callback=function(b,a){this.fn_callback=b;this.o_usr_data=a};tmedia_session_mgr.prototype.callback=function(b,a){if(this.fn_callback){if(b==tmedia_session_events_e.GET_LO_SUCCESS){this.b_lo_changed=true;if(this.ao_sessions.length>0){this.sdp.o_lo=this.ao_sessions[0].o_sdp_lo}}this.fn_callback(this.o_usr_data,b,a)}};tmedia_session_mgr.prototype.set_media_type=function(a){if(this.e_type!=a){this.b_media_type_changed=true;this.e_type=a}return 0};tmedia_session_mgr.prototype.get_media_type=function(){return this.e_type};tmedia_session_mgr.prototype.has_media=function(a){for(var b=0;b<this.ao_sessions.length;++b){if(this.ao_sessions[b].e_type==a){return true}}return false};tmedia_session_mgr.prototype.has_ro_changed=function(){return this.b_ro_changed};tmedia_session_mgr.prototype.has_state_changed=function(){return this.b_state_changed};tmedia_session_mgr.prototype.has_active_session=function(){for(var a=0;a<this.ao_sessions.length;++a){if(this.ao_sessions[a].o_sdp_lo){return true}}return false};tmedia_session_mgr.prototype.is_started=function(){return this.b_started};tmedia_session_mgr.prototype.has_lo=function(){return this.sdp.o_lo!=null};tmedia_session_mgr.prototype.has_ro=function(){return this.sdp.o_ro!=null};tmedia_session_mgr.prototype.remove_media=function(a){for(var b=0;b<this.ao_sessions.length;++b){if(this.ao_sessions[b].e_type==a){this.ao_sessions[b].stop();this.ao_sessions.splice(b,1);break}}};tmedia_session_mgr.prototype.apply_params=function(){var c;for(var b=0;b<this.ao_params.length;++b){if(!(c=this.ao_params[b])){continue}switch(c.e_type){case tmedia_param_type_e.CODEC:break;case tmedia_param_type_e.MANAGER:break;case tmedia_param_type_e.SESSION:for(var a=0;a<this.ao_sessions.length;++a){if(this.ao_sessions[a].e_type.i_id&c.e_media_type.i_id){this.ao_sessions[a].set(c)}}break}}this.ao_params.splice(0,this.ao_params.length)};tmedia_session_mgr.prototype.load_sessions=function(){var c=null;if(this.ao_sessions.length==0||this.b_media_type_changed){for(var b=0;b<tmedia_session_mgr.prototype.__ao_supported_media.length;++b){var a=tmedia_session_mgr.prototype.__ao_supported_media[b];if((a.i_id&this.e_type.i_id)&&!this.has_media(a)){if((c=tmedia_session.prototype.Create(a,this))){this.ao_sessions.push(c)}}else{if(!(a.i_id&this.e_type.i_id)&&this.has_media(a)){this.remove_media(a)}}}this.set(tmedia_session_mgr.prototype.SetParamSession(this.e_type,"local-ip",this.s_addr),tmedia_session_mgr.prototype.SetParamSession(this.e_type,"local-ipver",this.b_ipv6?"ipv6":"ipv4"));this.apply_params(self)}return 0};tmedia_session_mgr.prototype.__update_ro=function(e){this.sdp.o_ro=e;var b=true;var d=0;var a;while((a=e.get_header_at(tsdp_header_type_e.M,d++))){if(!a.is_held(false)){b=false;break}}for(var c=0;c<this.ao_sessions.length;++c){this.ao_sessions[c].b_ro_held=b}return 0};tmedia_session_mgr.prototype.get_lo=function(){if(this.ao_sessions.length==0){if(this.load_sessions()!=0){tsk_utils_log_error("Failed to prepare the session manager");return null}}if((this.b_ro_changed||this.b_lo_changed||this.b_state_changed||this.b_mediaType_changed)&&this.sdp.o_lo){this.sdp.o_lo=null;if(this.b_mediaType_changed){this.load_sessions()}this.b_lo_changed=false;this.b_ro_changed=false;this.b_state_changed=false;this.b_mediaType_changed=false}if(this.ao_sessions.length>0){this.sdp.o_lo=this.ao_sessions[0].get_lo()}return this.sdp.o_lo};tmedia_session_mgr.prototype.set_ro=function(l,m){if(!l){tsk_utils_log_error("Invalid parameter");return -1}var k=0;var h=false;var d=false;var c=false;var e=tmedia_type_e.NONE;var f=false;var b=(this.sdp.o_ro!=null);var j;var a;if((j=l.get_header(tsdp_header_type_e.O))){if(this.sdp.i_ro_ver==j.i_sess_version){tsk_utils_log_warn("Remote offer has not changed");return 0}this.sdp.i_ro_ver=j.i_sess_version}else{tsk_utils_log_error("o= line is missing");return -2}if((a=l.get_header(tsdp_header_type_e.C))&&a.s_addr){f=(tsk_string_iequals("IP4",a.s_addrtype)&&tsk_string_iequals("127.0.0.1",a.s_addr))||(tsk_string_iequals("IP6",a.s_addrtype)&&tsk_string_iequals("::1",a.s_addr))}if(this.sdp.o_lo){e=l.get_media_type();if(e==tmedia_type_e.VIDEO&&this.e_type==tmedia_type_e.SCREEN_SHARE){e=this.e_type}if((c=(e!=this.e_type))){tsk_utils_log_error("this.set_media_type(e_new_mediatype);");tsk_utils_log_info("media type has changed")}}if(this.b_started&&!(this.is_roap()||this.is_jsep())&&((!d&&!f)||c)){if((k=this.stop())){tsk_utils_log_error("Failed to stop session manager");return k}h=true}this.__update_ro(l);if((k=this.load_sessions())){tsk_utils_log_error("Failed to prepare the session manager");return k}if(a&&a.s_addr){this.set(tmedia_session_mgr.prototype.SetParamSession(this.e_type,"remote-ip",a.s_addr))}for(var g=0;g<this.ao_sessions.length;++g){this.ao_sessions[g].set_ro(l,m)}this.b_ro_changed=b;(this.get_lo(self));if(h){if((k=this.start())){tsk_utils_log_warn("Failed to re-start session manager");return k}}return 0};tmedia_session_mgr.prototype.processContent=function(d,b,c,e){for(var a=0;a<this.ao_sessions.length;++a){this.ao_sessions[a].processContent(d,b,c,e)}};tmedia_session_mgr.prototype.start=function(){var b=0;for(var a=0;a<this.ao_sessions.length;++a){if((b=this.ao_sessions[a].start())){return b}}this.b_started=true;return 0};tmedia_session_mgr.prototype.stop=function(){var b=0;for(var a=0;a<this.ao_sessions.length;++a){if((b=this.ao_sessions[a].stop())){return b}}this.b_started=false;return 0};tmedia_session_mgr.prototype.acked=function(){var b=0;for(var a=0;a<this.ao_sessions.length;++a){if((b=this.ao_sessions[a].acked())){return b}}return 0};tmedia_session_mgr.prototype.is_held=function(d,a){var c=false;var h;var b;var g;for(var e=0;e<this.ao_sessions.length;++e){var f=this.ao_sessions[e];if(!d||(f.e_type.i_id&d.i_id)){if(a&&f.o_sdp_lo){g=f.o_sdp_lo}else{if(!a&&f.o_sdp_ro){g=f.o_sdp_ro}else{continue}}c=true;h=0;while((b=g.get_header_at(tsdp_header_type_e.M,h++))){if(!b.is_held(a)){return false}}}}return c?true:false};tmedia_session_mgr.prototype.hold=function(a){var c;for(var b=0;b<this.ao_sessions.length;++b){if(!a||(this.ao_sessions[b].e_type.i_id&a.i_id)){this.b_state_changed=true;if(c=this.ao_sessions[b].hold()){return c}this.ao_sessions[b].b_lo_held=true}}return 0};tmedia_session_mgr.prototype.resume=function(a){var c;for(var b=0;b<this.ao_sessions.length;++b){if(!a||(this.ao_sessions[b].e_type.i_id&a.i_id)){this.b_state_changed=true;if(c=this.ao_sessions[b].resume()){return c}this.ao_sessions[b].b_lo_held=false}}return 0};tmedia_session_mgr.prototype.set=function(){for(var a=0;a<arguments.length;++a){if(arguments[a]){this.ao_params.push(arguments[a])}}if(this.ao_sessions.length>0){this.apply_params()}};tmedia_session_mgr.prototype.SetParamSession=function(b,a,c){return new tmedia_param(tmedia_param_type_e.SESSION,b,a,c)};tmedia_session_mgr.prototype.SetParamCodec=function(b,a,c){return new tmedia_param(tmedia_param_type_e.CODEC,b,a,c)};tmedia_session_mgr.prototype.SetParam=function(b,a,c){return new tmedia_param(tmedia_param_type_e.MANAGER,b,a,c)};function tmedia_session(b,a){this.e_type=b;this.b_ro_changed=false;this.b_initialized=false;this.b_prepared=false;this.b_lo_held=false;this.b_ro_held=false;this.o_sdp=null;this.o_mgr=a}tmedia_session.prototype.set=function(a){return this.__set(a)};tmedia_session.prototype.prepare=function(){return this.__prepare()};tmedia_session.prototype.start=function(){return this.__start()};tmedia_session.prototype.pause=function(){return this.__pause()};tmedia_session.prototype.stop=function(){return this.__stop()};tmedia_session.prototype.get_lo=function(){return this.__get_lo()};tmedia_session.prototype.set_ro=function(b,a){return this.__set_ro(b,a)};tmedia_session.prototype.processContent=function(c,a,b,d){if(this.__processContent){return this.__processContent(c,a,b,d)}};tmedia_session.prototype.acked=function(){return this.__acked()};tmedia_session.prototype.hold=function(){return this.__hold()};tmedia_session.prototype.resume=function(){return this.__resume()};tmedia_session.prototype.Create=function(b,a){switch(b){case tmedia_type_e.AUDIO:case tmedia_type_e.VIDEO:case tmedia_type_e.SCREEN_SHARE:if(a.ao_sessions.length==0){if(a.is_jsep()){return tmedia_session_jsep.prototype.CreateInstance(a)}else{return new tmedia_session_roap(a)}}return null;case tmedia_type_e.GHOST:return new tmedia_session_ghost(a);default:tsk_utils_log_error(b+" not supported as media type");return null}};if(!window.__b_release_mode){tmedia_api_add_js_scripts("head","src/tinyMEDIA/src/tmedia_session_jsep.js","src/tinyMEDIA/src/tmedia_session_roap.js","src/tinyMEDIA/src/tmedia_session_ghost.js")};