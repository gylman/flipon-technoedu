SIPml={};SIPml.b_initialized=false;SIPml.b_initializing=false;SIPml.s_navigator_friendly_name="unknown";SIPml.b_navigator_outdated=false;SIPml.s_navigator_version="unknown";SIPml.s_system_friendly_name="unknown";SIPml.b_webrtc4all_plugin_outdated=false;SIPml.b_webrtc4all_supported=false;SIPml.s_webrtc4all_version="unknown";SIPml.b_have_media_stream=false;SIPml.b_webrtc_supported=false;SIPml.setDebugLevel=function(a){tsk_utils_log_set_level(a==="fatal"?1:(a==="error"?2:(a==="warn"?3:4)))};SIPml.setWebRtcType=function(a){if(SIPml.isInitialized()){throw new Error("ERR_ALREADY_INITIALIZED: Engine already initialized.")}return WebRtc4all_SetType(a)};SIPml.getWebRtc4AllVersion=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.s_webrtc4all_version};SIPml.getNavigatorVersion=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.s_navigator_version};SIPml.getNavigatorFriendlyName=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.s_navigator_friendly_name};SIPml.getSystemFriendlyName=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.s_system_friendly_name};SIPml.isNavigatorOutdated=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.b_navigator_outdated};SIPml.isWebRtc4AllPluginOutdated=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.b_webrtc4all_plugin_outdated};SIPml.isWebRtc4AllSupported=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.b_webrtc4all_supported};SIPml.isScreenShareSupported=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return(navigator.userAgent.match("Chrome")&&parseInt(navigator.userAgent.match(/Chrome\/(.*) /)[1])>=26)};SIPml.isWebRtcSupported=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.b_webrtc_supported};SIPml.isWebSocketSupported=function(){return tsk_utils_have_websocket()};SIPml.haveMediaStream=function(){if(!SIPml.isInitialized()){throw new Error("ERR_NOT_INITIALIZED: Engine not initialized yet. Please call 'SIPml.init()' first")}return SIPml.b_have_media_stream};SIPml.isReady=function(){return(SIPml.isInitialized()&&SIPml.isWebRtcSupported()&&SIPml.haveMediaStream())};SIPml.isInitialized=function(){return SIPml.b_initialized};SIPml.init=function(a,b){if(!SIPml.b_initialized&&!SIPml.b_initializing){SIPml.b_initializing=true;tsk_utils_init_webrtc();tsk_utils_log_info("User-Agent="+(navigator.userAgent||"unknown"));SIPml.b_have_media_stream=tsk_utils_have_stream();SIPml.b_webrtc_supported=tsk_utils_have_webrtc();SIPml.b_webrtc4all_supported=tsk_utils_have_webrtc4all();SIPml.s_webrtc4all_version=tsk_utils_webrtc4all_get_version();SIPml.s_navigator_friendly_name=tsk_utils_get_navigator_friendly_name();SIPml.s_system_friendly_name=tsk_utils_get_system_friendly_name();tsk_utils_log_info("WebSocket supported = "+(SIPml.isWebSocketSupported()?"yes":"no"));if(tsk_utils_have_webrtc4all()){tsk_utils_log_info("WebRTC type = "+WebRtc4all_GetType()+" version = "+tsk_utils_webrtc4all_get_version());if(SIPml.s_webrtc4all_version!="1.35.981"){SIPml.b_webrtc4all_plugin_outdated=true}}tsk_utils_log_info("Navigator friendly name = "+SIPml.s_navigator_friendly_name);if(SIPml.s_navigator_friendly_name=="ie"){var e=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(e.exec(navigator.userAgent)!=null){SIPml.s_navigator_version=RegExp.$1}}tsk_utils_log_info("OS friendly name = "+SIPml.s_system_friendly_name);tsk_utils_log_info("Have WebRTC = "+(tsk_utils_have_webrtc()?"yes":"false"));tsk_utils_log_info("Have GUM = "+(tsk_utils_have_stream()?"yes":"false"));if(!tsk_utils_have_webrtc()){if(SIPml.s_navigator_friendly_name=="chrome"){SIPml.b_navigator_outdated=true;return}if(SIPml.s_system_friendly_name=="win"||SIPml.s_system_friendly_name=="windows"){if(SIPml.s_navigator_friendly_name=="ie"){var f=-1;var c=navigator.userAgent;var e=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(e.exec(c)!=null){f=parseFloat(RegExp.$1)}if(f<9){SIPml.b_navigator_outdated=true;return}if(!tsk_utils_have_webrtc4all()){return}}}}if(SIPml.b_webrtc_supported&&SIPml.b_have_media_stream){SIPml.b_initialized=true;SIPml.b_initializing=false;tsk_utils_log_info("Engine initialized");if(a){a({})}}else{if(b){var d=!SIPml.b_webrtc_supported?"WebRTC not supported":(!SIPml.b_have_media_stream?"getUserMedia not supported":"Internal error");b({description:d})}}}};SIPml.EventTarget=function(){this.ao_listeners=[]};SIPml.EventTarget.prototype.addEventListener=function(b,a){if(!a){throw new Error("ERR_INVALID_PARAMETER_VALUE: 'listener' must not be null")}if(!b){throw new Error("ERR_INVALID_PARAMETER_VALUE: 'type' must not be null")}if(!(b instanceof String||typeof b=="string"||b instanceof Array)){throw new Error("ERR_INVALID_PARAMETER_TYPE: 'type' must be a string or array")}if(b instanceof Array){var c=this;b.forEach(function(d){if(!tsk_string_is_null_or_empty(d)&&tsk_string_is_string(d)){c.ao_listeners[d]=a}})}else{this.ao_listeners[b]=a}};SIPml.EventTarget.prototype.removeEventListener=function(a){if(tsk_string_is_string(a)&&!tsk_string_is_null_or_empty(a)){this.ao_listeners[a]=undefined}};SIPml.EventTarget.prototype.dispatchEvent=function(b){var a=(this.ao_listeners[b.s_type]||this.ao_listeners["*"]);if(a){a.call(this,b.o_value)}};SIPml.Event=function(a,b){this.type=a;this.description=b?b.s_phrase:a;this.o_event=b};SIPml.Event.prototype.getSipResponseCode=function(){var a=this.o_event?this.o_event.get_message():null;if(a&&a.is_response()){return a.get_response_code()}return -1};SIPml.Event.prototype.getContent=function(){var a=this.o_event?this.o_event.get_message():null;if(a){return a.get_content()}return null};SIPml.Event.prototype.getContentString=function(){var a=this.o_event?this.o_event.get_message():null;if(a){return a.get_content_as_string()}return null};SIPml.Event.prototype.getContentType=function(){var a=this.o_event?this.o_event.get_message():null;if(a){return a.get_content_type()}return null};SIPml.Stack=function(a){SIPml.init();SIPml.EventTarget.call(this);if(!a){throw new Error("ERR_INVALID_PARAMETER_VALUE: null configuration value")}if(tsk_string_is_null_or_empty(a.realm)){throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+a.realm+"' is not valid as realm value")}if(tsk_string_is_null_or_empty(a.impi)){throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+a.impi+"' is not valid as impi value")}if(tsk_string_is_null_or_empty(a.impu)){throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+a.impu+"' is not valid as impu value")}var b=tsip_uri.prototype.Parse(a.impu);if(!b||!b.s_user_name||!b.s_host){throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+a.impu+"' is not valid as SIP Uri")}var d;var c;if(!SIPml.isWebSocketSupported()){d=5060;c=a.realm}else{d=(a.enable_rtcweb_breaker?10062:10060)+(((new Date().getTime())%5)*1000);c="ns313841.ovh.net"}this.o_stack=new tsip_stack(a.realm,a.impi,a.impu,c,d);this.o_stack.oStack=this;this.setConfiguration(a);this.o_stack.on_event_stack=function(g){var f;switch(g.i_code){case tsip_event_code_e.STACK_STARTING:f="starting";break;case tsip_event_code_e.STACK_STARTED:f="started";break;case tsip_event_code_e.STACK_STOPPING:f="stopping";break;case tsip_event_code_e.STACK_STOPPED:f="stopped";break;case tsip_event_code_e.STACK_FAILED_TO_START:f="failed_to_start";break;case tsip_event_code_e.STACK_FAILED_TO_STOP:f="failed_to_stop";break}if(f){g.o_stack.oStack.dispatchEvent({s_type:f,o_value:new SIPml.Stack.Event(f,g)})}};this.o_stack.on_event_dialog=function(i){var f=null;var g=i.o_session.i_id;var h=i.o_session.o_stack.oStack.ao_sessions[g];if(!h){tsk_utils_log_warn("Cannot find session with id = "+g);return}switch(i.i_code){case tsip_event_code_e.DIALOG_TRANSPORT_ERROR:f="transport_error";break;case tsip_event_code_e.DIALOG_GLOBAL_ERROR:f="global_error";break;case tsip_event_code_e.DIALOG_MESSAGE_ERROR:f="message_error";break;case tsip_event_code_e.DIALOG_WEBRTC_ERROR:f="webrtc_error";break;case tsip_event_code_e.DIALOG_REQUEST_INCOMING:f="i_request";break;case tsip_event_code_e.DIALOG_REQUEST_OUTGOING:f="o_request";break;case tsip_event_code_e.DIALOG_REQUEST_CANCELLED:f="cancelled_request";break;case tsip_event_code_e.DIALOG_REQUEST_SENT:f="sent_request";break;case tsip_event_code_e.DIALOG_MEDIA_ADDED:f="media_added";break;case tsip_event_code_e.DIALOG_MEDIA_REMOVED:f="media_removed";break;case tsip_event_code_e.DIALOG_CONNECTING:f="connecting";break;case tsip_event_code_e.DIALOG_CONNECTED:f="connected";break;case tsip_event_code_e.DIALOG_TERMINATING:f="terminating";break;case tsip_event_code_e.DIALOG_TERMINATED:f="terminated";i.o_session.o_stack.oStack.ao_sessions[g]=undefined;break;default:break}if(f){h.dispatchEvent({s_type:f,o_value:new SIPml.Session.Event(h,f,i)})}};this.o_stack.on_event_message=function(i){var f=null;var g=i.o_session.i_id;var h=i.o_session.o_stack.oStack.ao_sessions[g];switch(i.e_message_type){case tsip_event_message_type_e.I_MESSAGE:f="i_new_message";break;case tsip_event_message_type_e.AO_MESSAGE:f="i_ao_request";break}if(f){if(f=="i_new_message"){var j=new SIPml.Stack.Event(f,i);j.newSession=new SIPml.Session.Message(i.o_session);i.o_session.o_stack.oStack.ao_sessions[g]=j.newSession;i.o_session.o_stack.oStack.dispatchEvent({s_type:f,o_value:j})}else{if(h){h.dispatchEvent({s_type:f,o_value:new SIPml.Session.Event(h,f,i)})}else{tsk_utils_log_warn("Cannot find session with id = "+g+" and event = "+i.e_invite_type)}}}};this.o_stack.on_event_publish=function(i){var f=null;var g=i.o_session.i_id;var h=i.o_session.o_stack.oStack.ao_sessions[g];if(!h){tsk_utils_log_warn("Cannot find session with id = "+g+" and event = "+i.e_invite_type);return}switch(i.e_publish_type){case tsip_event_publish_type_e.I_PUBLISH:break;case tsip_event_publish_type_e.I_UNPUBLISH:break;case tsip_event_publish_type_e.AO_PUBLISH:case tsip_event_publish_type_e.AO_UNPUBLISH:f="i_ao_request";break}if(f){h.dispatchEvent({s_type:f,o_value:new SIPml.Session.Event(h,f,i)})}};this.o_stack.on_event_subscribe=function(i){var f=null;var g=i.o_session.i_id;var h=i.o_session.o_stack.oStack.ao_sessions[g];if(!h){tsk_utils_log_warn("Cannot find session with id = "+g+" and event = "+i.e_invite_type);return}switch(i.e_subscribe_type){case tsip_event_subscribe_type_e.I_SUBSCRIBE:break;case tsip_event_subscribe_type_e.I_UNSUBSRIBE:break;case tsip_event_subscribe_type_e.AO_SUBSCRIBE:case tsip_event_subscribe_type_e.AO_UNSUBSCRIBE:case tsip_event_subscribe_type_e.AO_NOTIFY:f="i_ao_request";break;case tsip_event_subscribe_type_e.I_NOTIFY:f="i_notify";break}if(f){h.dispatchEvent({s_type:f,o_value:new SIPml.Session.Event(h,f,i)})}};this.o_stack.on_event_invite=function(j){var f=null;var h=j.o_session.i_id;var i=j.o_session.o_stack.oStack.ao_sessions[h];if(!i){switch(j.e_invite_type){case tsip_event_invite_type_e.I_NEW_CALL:case tsip_event_invite_type_e.M_STREAM_LOCAL_REQUESTED:case tsip_event_invite_type_e.M_STREAM_LOCAL_ACCEPTED:case tsip_event_invite_type_e.M_STREAM_LOCAL_REFUSED:break;case tsip_event_invite_type_e.M_STREAM_LOCAL_ADDED:case tsip_event_invite_type_e.M_STREAM_REMOTE_ADDED:case tsip_event_invite_type_e.M_STREAM_LOCAL_REMOVED:case tsip_event_invite_type_e.M_STREAM_REMOTE_REMOVED:case tsip_event_invite_type_e.I_AO_REQUEST:tsk_utils_log_info("Not notifying to session with id = "+h+" for event = "+j.e_invite_type);return;default:tsk_utils_log_warn("Cannot find session with id = "+h+" and event = "+j.e_invite_type);return}}var m=function(e,o,p,n){if(o){if(!n&&o.videoTracks.length>0){if(window.HTMLVideoElement&&e instanceof window.HTMLVideoElement){if((e.src=p)){e.play()}}return true}if(n&&o.audioTracks.length>0){if(window.HTMLAudioElement&&e instanceof window.HTMLAudioElement){if((e.src=p)){e.play()}}return true}}};var l=function(e){var n=e?j.o_session.get_stream_local():j.o_session.get_stream_remote();var o=e?j.o_session.get_url_local():j.o_session.get_url_remote();if(m((e?i.videoLocal:i.videoRemote),n,o,false)){k(e?"m_stream_video_local_added":"m_stream_video_remote_added")}if(m((e?i.audioLocal:i.audioRemote),n,o,true)){k(e?"m_stream_audio_local_added":"m_stream_audio_remote_added")}};var g=function(e){var n=e?j.o_session.get_stream_local():j.o_session.get_stream_remote();if(m((e?i.videoLocal:i.videoRemote),n,null,false)){k(e?"m_stream_video_local_removed":"m_stream_video_remote_removed")}if(m((e?i.audioLocal:i.audioRemote),n,null,true)){k(e?"m_stream_audio_local_removed":"m_stream_audio_remote_removed")}};var k=function(e){if(e){switch(e){case"i_new_call":case"m_permission_requested":case"m_permission_accepted":case"m_permission_refused":var n=new SIPml.Stack.Event(e,j);if(e=="i_new_call"){n.newSession=new SIPml.Session.Call(j.o_session);j.o_session.o_stack.oStack.ao_sessions[h]=n.newSession}j.o_session.o_stack.oStack.dispatchEvent({s_type:e,o_value:n});break;default:i.dispatchEvent({s_type:e,o_value:new SIPml.Session.Event(i,e,j)});break}}};switch(j.e_invite_type){case tsip_event_invite_type_e.I_NEW_CALL:f="i_new_call";break;case tsip_event_invite_type_e.I_ECT_NEW_CALL:f="i_ect_new_call";break;case tsip_event_invite_type_e.I_AO_REQUEST:f="i_ao_request";break;case tsip_event_invite_type_e.M_EARLY_MEDIA:f="m_early_media";break;case tsip_event_invite_type_e.M_STREAM_LOCAL_REQUESTED:f="m_permission_requested";break;case tsip_event_invite_type_e.M_STREAM_LOCAL_ACCEPTED:f="m_permission_accepted";break;case tsip_event_invite_type_e.M_STREAM_LOCAL_REFUSED:f="m_permission_refused";break;case tsip_event_invite_type_e.M_STREAM_LOCAL_ADDED:return l(true);case tsip_event_invite_type_e.M_STREAM_LOCAL_REMOVED:return g(true);case tsip_event_invite_type_e.M_STREAM_REMOTE_ADDED:return l(false);case tsip_event_invite_type_e.M_STREAM_REMOTE_REMOVED:return g(false);case tsip_event_invite_type_e.M_LOCAL_HOLD_OK:f="m_local_hold_ok";break;case tsip_event_invite_type_e.M_LOCAL_HOLD_NOK:f="m_local_hold_nok";break;case tsip_event_invite_type_e.M_LOCAL_RESUME_OK:f="m_local_resume_ok";break;case tsip_event_invite_type_e.M_LOCAL_RESUME_NOK:f="m_local_resume_nok";break;case tsip_event_invite_type_e.M_REMOTE_HOLD:f="m_remote_hold";break;case tsip_event_invite_type_e.M_REMOTE_RESUME:f="m_remote_resume";break;case tsip_event_invite_type_e.O_ECT_TRYING:f="o_ect_trying";break;case tsip_event_invite_type_e.O_ECT_ACCEPTED:f="o_ect_accepted";break;case tsip_event_invite_type_e.O_ECT_COMPLETED:f="o_ect_completed";break;case tsip_event_invite_type_e.I_ECT_COMPLETED:f="i_ect_completed";break;case tsip_event_invite_type_e.O_ECT_FAILED:f="o_ect_failed";break;case tsip_event_invite_type_e.I_ECT_FAILED:f="i_ect_failed";break;case tsip_event_invite_type_e.O_ECT_NOTIFY:f="o_ect_notify";break;case tsip_event_invite_type_e.I_ECT_NOTIFY:f="i_ect_notify";break;case tsip_event_invite_type_e.I_ECT_REQUESTED:f="i_ect_requested";break;case tsip_event_invite_type_e.DIALOG_REQUEST_INCOMING:if(j.o_message){if(j.o_message.is_info()){f="i_info"}}break;default:break}k(f)}};SIPml.Stack.prototype=Object.create(SIPml.EventTarget.prototype);SIPml.Stack.prototype.ao_sessions=[];SIPml.Stack.prototype.setConfiguration=function(c){if(c.realm&&!tsk_string_is_string(c.realm)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.realm+"' not a valid type for realm. String is expected")}if(c.impi&&!tsk_string_is_string(c.impi)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.impi+"' not a valid type for impi. String is expected")}if(c.impu&&!tsk_string_is_string(c.impu)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.impu+"' not a valid type for impu. String is expected")}if(c.password&&!tsk_string_is_string(c.password)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.password+"' not a valid type for password. String is expected")}if(c.display_name&&!tsk_string_is_string(c.display_name)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.display_name+"' not a valid type for display_name. String is expected")}if(c.websocket_proxy_url&&!tsk_string_is_string(c.websocket_proxy_url)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.websocket_proxy_url+"' not a valid type for websocket_proxy_url. String is expected")}if(c.outbound_proxy_url&&!tsk_string_is_string(c.outbound_proxy_url)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.outbound_proxy_url+"' not a valid type for outbound_proxy_url. String is expected")}if(c.sip_headers&&typeof c.sip_headers!="Array"&&!(c.sip_headers instanceof Array)){throw new Error("ERR_INVALID_PARAMETER_TYPE: '"+typeof c.sip_headers+"' not a valid type for sip_headers. Array is expected")}if(c.events_listener){this.addEventListener(c.events_listener.events,c.events_listener.listener)}var f=!!c.enable_rtcweb_breaker;var g=!!c.enable_click2call;var h=(c.enable_early_ims==undefined)?true:!!c.enable_early_ims;var d=!!c.enable_media_stream_cache;var a=c.bandwidth?c.bandwidth:{audio:undefined,video:undefined};var e=c.video_size?c.video_size:{minWidth:undefined,minHeight:undefined,maxWidth:undefined,maxHeight:undefined};var b=this.o_stack;tsk_utils_log_info("s_websocket_server_url="+(c.websocket_proxy_url||"(null)"));tsk_utils_log_info("s_sip_outboundproxy_url="+(c.outbound_proxy_url||"(null)"));tsk_utils_log_info("b_rtcweb_breaker_enabled="+(f?"yes":"no"));tsk_utils_log_info("b_click2call_enabled="+(g?"yes":"no"));tsk_utils_log_info("b_early_ims="+(h?"yes":"no"));tsk_utils_log_info("b_enable_media_stream_cache="+(d?"yes":"no"));tsk_utils_log_info("o_bandwidth="+JSON.stringify(a));tsk_utils_log_info("o_video_size="+JSON.stringify(e));b.set(tsip_stack.prototype.SetPassword(c.password),tsip_stack.prototype.SetDisplayName(c.display_name),tsip_stack.prototype.SetProxyOutBoundUrl(c.outbound_proxy_url),tsip_stack.prototype.SetRTCWebBreakerEnabled(f),tsip_stack.prototype.SetClick2CallEnabled(g),tsip_stack.prototype.SetSecureTransportEnabled(f),tsip_stack.prototype.SetEarlyIMSEnabled(h),tsip_stack.prototype.SetWebsocketServerUrl(c.websocket_proxy_url),tsip_stack.prototype.SetIceServers(c.ice_servers),tsip_stack.prototype.SetMediaStreamCacheEnabled(d),tsip_stack.prototype.SetBandwidth(a),tsip_stack.prototype.SetVideoSize(e));if(c.sip_headers){c.sip_headers.forEach(function(i){if(i&&!tsk_string_is_null_or_empty(i.name)&&(!i.value||tsk_string_is_string(i.value))){b.set(tsip_stack.prototype.SetHeader(i.name,i.value))}})}return 0};SIPml.Stack.prototype.start=function(){return this.o_stack.start()};SIPml.Stack.prototype.stop=function(a){return this.o_stack.stop(a)};SIPml.Stack.prototype.newSession=function(a,c){var d;var b;if(a=="register"){d=new tsip_session_register(this.o_stack);b=SIPml.Session.Registration}else{if(a=="message"){d=new tsip_session_message(this.o_stack);b=SIPml.Session.Message}else{if(a=="publish"){d=new tsip_session_publish(this.o_stack);b=SIPml.Session.Publish}else{if(a=="subscribe"){d=new tsip_session_subscribe(this.o_stack);b=SIPml.Session.Subscribe}else{if(a=="call-audio"||a=="call-audiovideo"||a=="call-video"||a=="call-screenshare"){d=new tsip_session_invite(this.o_stack);d.s_type=a;b=SIPml.Session.Call}else{throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+a+"' not valid as session type")}}}}}d.b_local=true;var e=new b(d,c);this.ao_sessions[e.getId()]=e;return e};SIPml.Stack.Event=function(a,b){SIPml.Event.call(this,a,b)};SIPml.Stack.Event.prototype=Object.create(SIPml.Event.prototype);SIPml.Session=function(b,a){SIPml.EventTarget.call(this);if(!b){throw new Error("ERR_INVALID_PARAMETER_VALUE: Invalid session value")}this.o_session=b;this.setConfiguration(a)};SIPml.Session.prototype=Object.create(SIPml.EventTarget.prototype);SIPml.Session.prototype.o_session=null;SIPml.Session.prototype.o_session=null;SIPml.Session.prototype.o_configuration=null;SIPml.Session.prototype.getId=function(){return this.o_session.get_id()};SIPml.Session.prototype.setConfiguration=function(b){if(!b){return}var c=this.o_session;if(b.events_listener){this.addEventListener(b.events_listener.events,b.events_listener.listener)}if(this instanceof SIPml.Session.Call){c.set(tsip_session.prototype.SetBandwidth(b.bandwidth?b.bandwidth:{audio:undefined,video:undefined}),tsip_session.prototype.SetVideoSize(b.video_size?b.video_size:{minWidth:undefined,minHeight:undefined,maxWidth:undefined,maxHeight:undefined}));this.videoLocal=b.video_local;this.videoRemote=b.video_remote;this.audioRemote=b.audio_remote;this.audioLocal=b.audio_local;var a=function(d,f,g,e){if(f){if(!e&&f.videoTracks.length>0){if(window.HTMLVideoElement&&d instanceof window.HTMLVideoElement){if(d.src==g){return false}else{if(d.src=g){d.play()}}}return true}if(e&&f.audioTracks.length>0){if(window.HTMLAudioElement&&d instanceof window.HTMLAudioElement){if(d.src==g){return false}else{if(d.src=g){d.play()}}}return true}}};if(a(this.videoLocal,c.get_stream_local(),c.get_url_local(),false)){this.dispatchEvent({s_type:"m_stream_video_local_added",o_value:new SIPml.Session.Event(this,"m_stream_video_local_added")})}if(a(this.videoRemote,c.get_stream_remote(),c.get_url_remote(),false)){this.dispatchEvent({s_type:"m_stream_video_remote_added",o_value:new SIPml.Session.Event(this,"m_stream_video_remote_added")})}if(a(this.audioLocal,c.get_stream_local(),c.get_url_local(),true)){this.dispatchEvent({s_type:"m_stream_audio_local_added",o_value:new SIPml.Session.Event(this,"m_stream_audio_local_added")})}if(a(this.audioRemote,c.get_stream_remote(),c.get_url_remote(),true)){this.dispatchEvent({s_type:"m_stream_audio_remote_added",o_value:new SIPml.Session.Event(this,"m_stream_audio_remote_added")})}}if(b.sip_headers){b.sip_headers.forEach(function(d){if(d&&!tsk_string_is_null_or_empty(d.name)&&(!d.value||tsk_string_is_string(d.value))){c.set(tsip_session.prototype.SetHeader(d.name,d.value))}})}if(b.sip_caps){b.sip_caps.forEach(function(d){if(d&&!tsk_string_is_null_or_empty(d.name)&&(!d.value||tsk_string_is_string(d.value))){c.set(tsip_session.prototype.SetCaps(d.name,d.value))}})}if(b.expires){c.set(tsip_session.prototype.SetExpires(b.expires))}if(b.from){c.set(tsip_session.prototype.SetFromStr(b.from))}};SIPml.Session.prototype.getRemoteUri=function(){return(this.o_session.b_local?this.o_session.o_uri_to:this.o_session.o_uri_from).toString()};SIPml.Session.prototype.getRemoteFriendlyName=function(){var a=this.o_session.b_local?this.o_session.o_uri_to:this.o_session.o_uri_from;return a.s_display_name?a.s_display_name:a.s_user_name};SIPml.Session.prototype.reject=function(a){this.setConfiguration(a);return this.o_session.reject()};SIPml.Session.prototype.accept=function(a){this.setConfiguration(a);return this.o_session.accept()};SIPml.Session.Event=function(c,a,b){SIPml.Event.call(this,a,b);this.session=c};SIPml.Session.Event.prototype=Object.create(SIPml.Event.prototype);SIPml.Session.Event.prototype.getTransferDestinationFriendlyName=function(){var a=this.o_event?this.o_event.get_message():null;if(a){var b=a.get_header(tsip_header_type_e.Refer_To);if(b&&b.o_uri){return(b.s_display_name?b.s_display_name:b.o_uri.s_user_name)}}return null};SIPml.Session.Registration=function(b,a){SIPml.Session.call(this,b,a)};SIPml.Session.Registration.prototype=Object.create(SIPml.Session.prototype);SIPml.Session.Registration.prototype.register=function(a){this.setConfiguration(a);return this.o_session.register()};SIPml.Session.Registration.prototype.unregister=function(a){this.setConfiguration(a);return this.o_session.unregister()};SIPml.Session.Call=function(b,a){SIPml.Session.call(this,b,a);switch(b.s_type){case"call-audio":this.mediaType=tmedia_type_e.AUDIO;break;case"call-audiovideo":this.mediaType=tmedia_type_e.AUDIO_VIDEO;break;case"call-video":this.mediaType=tmedia_type_e.VIDEO;break;case"call-screenshare":this.mediaType=tmedia_type_e.SCREEN_SHARE;break}};SIPml.Session.Call.prototype=Object.create(SIPml.Session.prototype);SIPml.Session.Call.prototype.videoLocal=null;SIPml.Session.Call.prototype.videoRemote=null;SIPml.Session.Call.prototype.call=function(a,b){if(tsk_string_is_null_or_empty(a)){throw new Error("ERR_INVALID_PARAMETER_VALUE: 'to' must not be null")}if(!SIPml.haveMediaStream()){throw new Error("ERR_NOT_READY: Media engine not ready yet")}this.o_session.set(tsip_session.prototype.SetToStr(a));this.setConfiguration(b);return this.o_session.call(this.mediaType)};SIPml.Session.Call.prototype.hangup=function(a){this.setConfiguration(a);return this.o_session.hangup()};SIPml.Session.Call.prototype.hold=function(a){this.setConfiguration(a);return this.o_session.hold(this.mediaType)};SIPml.Session.Call.prototype.resume=function(a){this.setConfiguration(a);return this.o_session.resume(this.mediaType)};SIPml.Session.Call.prototype.info=function(b,c,a){this.setConfiguration(a);return this.o_session.info(b,c)};SIPml.Session.Call.prototype.dtmf=function(b,a){this.setConfiguration(a);return this.o_session.dtmf(b)};SIPml.Session.Call.prototype.transfer=function(a,b){this.setConfiguration(b);return this.o_session.transfer(a)};SIPml.Session.Call.prototype.acceptTransfer=function(a){this.setConfiguration(a);return this.o_session.transfer_accept()};SIPml.Session.Call.prototype.rejectTransfer=function(a){this.setConfiguration(a);return this.o_session.transfer_reject()};SIPml.Session.Message=function(b,a){SIPml.Session.call(this,b,a)};SIPml.Session.Message.prototype=Object.create(SIPml.Session.prototype);SIPml.Session.Message.prototype.send=function(a,c,d,b){if(tsk_string_is_null_or_empty(a)){throw new Error("ERR_INVALID_PARAMETER_VALUE: 'to' must not be null")}this.setConfiguration(b);this.o_session.set(tsip_session.prototype.SetToStr(a));return this.o_session.send(c,d)};SIPml.Session.Publish=function(b,a){SIPml.Session.call(this,b,a);b.set(tsip_session.prototype.SetToUri(b.get_stack().identity.o_uri_impu))};SIPml.Session.Publish.prototype=Object.create(SIPml.Session.prototype);SIPml.Session.Publish.prototype.publish=function(b,c,a){this.setConfiguration(a);return this.o_session.publish(b,c)};SIPml.Session.Publish.prototype.unpublish=function(a){this.setConfiguration(a);return this.o_session.unpublish()};SIPml.Session.Subscribe=function(b,a){SIPml.Session.call(this,b,a)};SIPml.Session.Subscribe.prototype=Object.create(SIPml.Session.prototype);SIPml.Session.Subscribe.prototype.subscribe=function(a,b){if(tsk_string_is_null_or_empty(a)){throw new Error("ERR_INVALID_PARAMETER_VALUE: 'to' must not be null")}this.o_session.set(tsip_session.prototype.SetToStr(a));this.setConfiguration(b);return this.o_session.subscribe()};SIPml.Session.Subscribe.prototype.unsubscribe=function(a){this.setConfiguration(a);return this.o_session.unsubscribe()};